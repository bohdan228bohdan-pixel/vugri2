{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4">
  <h1 class="mb-4">Кошик</h1>

  {% if cart %}
    <div class="card mb-3" style="background:transparent;border:0;">
      <div class="card-body" style="padding:0;">
        {% for pid, item in cart.items %}
          <div class="d-flex align-items-center mb-3" data-pid="{{ pid }}" style="border-bottom:1px solid rgba(255,255,255,0.04);padding:12px 0;">
            {% if item.image %}
              <img src="{{ item.image }}" alt="{{ item.name }}" style="width:84px;height:84px;object-fit:cover;border-radius:8px;margin-right:16px;">
            {% endif %}
            <div style="flex:1">
              <div style="font-weight:700;color:var(--white)">{{ item.name }}</div>
              <div style="color:var(--muted);font-size:0.95rem;margin-top:6px;">{{ item.price }} {{ item.currency }} / 100г</div>
            </div>

            <div style="text-align:right;min-width:260px">
              <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end">
                <button class="btn btn-outline-secondary qty-decr" aria-label="minus" style="width:40px;height:40px;border-radius:6px">−</button>
                <input class="cart-qty" type="number" min="1" value="{{ item.quantity }}" style="width:72px;text-align:center;border-radius:6px;padding:6px;background:rgba(255,255,255,0.03);color:var(--white);border:1px solid rgba(255,255,255,0.04)" step="1">
                <button class="btn btn-outline-secondary qty-incr" aria-label="plus" style="width:40px;height:40px;border-radius:6px">+</button>
              </div>
              <div style="font-weight:800;margin-top:8px;color:var(--white);font-size:1rem;">
                {{ item.price|add:"0" }} {{ item.currency }}
              </div>
            </div>
          </div>
        {% endfor %}

        <div style="margin-top:18px;border-top:1px solid rgba(255,255,255,0.04);padding-top:18px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div style="display:flex;gap:12px;align-items:center">
            <a href="{% url 'products' %}" class="btn btn-outline-light">← Продовжити покупки</a>
            <a href="{% url 'clear_cart' %}" class="btn btn-link text-danger" style="padding-left:0;padding-right:0">Очистити кошик</a>
          </div>

          <div style="font-weight:900;color:var(--white)">
            {% for cur, total in totals.items %}
              <div>{{ total }} {{ cur }}</div>
            {% endfor %}
          </div>

          <div>
            {% if first_pid %}
              <a id="checkoutLink" href="{% url 'order_form' first_pid %}" class="btn btn-danger">Оформити замовлення</a>
            {% else %}
              <button class="btn btn-danger" disabled>Оформити замовлення</button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="recommended" style="margin-top:28px">
      <h3 style="margin-top:6px;color:var(--white)">Рекомендуємо придбати</h3>
      <div class="rec-grid" style="display:flex;gap:12px;overflow:auto;padding-top:12px">
        {% for p in products %}
          <div class="rec-card" style="min-width:150px;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px;text-align:center;">
            {% if p.image %}
              <img src="{{ p.image.url }}" alt="{{ p.name }}" style="width:100%;height:96px;object-fit:cover;border-radius:6px">
            {% endif %}
            <div style="font-weight:700; margin-top:8px;color:var(--white)">{{ p.name }}</div>
            <div style="color:var(--muted)">{{ p.price_per_100g }} грн</div>
            <button class="btn rec-add" data-id="{{ p.id }}" data-price="{{ p.price_per_100g }}" style="margin-top:8px;background:var(--accent-red);color:#fff;border:none;padding:6px 8px;border-radius:6px;font-weight:700">До кошика</button>
          </div>
        {% empty %}
          <div style="color:var(--muted)">Немає рекомендацій на цей момент</div>
        {% endfor %}
      </div>
    </div>

  {% else %}
    <p style="color:var(--muted)">Кошик порожній — додайте продукти зі сторінки товару.</p>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const c = cookies[i].trim();
        if (c.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(c.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // Helpers
  function findContainer(btn) {
    return btn.closest('[data-pid]');
  }

  // Increment
  document.querySelectorAll('.qty-incr').forEach(btn => btn.addEventListener('click', () => {
    const container = findContainer(btn);
    const inp = container.querySelector('.cart-qty');
    inp.value = Math.max(1, parseInt(inp.value||1) + 1);
    updateItem(container.dataset.pid, inp.value);
  }));

  // Decrement
  document.querySelectorAll('.qty-decr').forEach(btn => btn.addEventListener('click', () => {
    const container = findContainer(btn);
    const inp = container.querySelector('.cart-qty');
    inp.value = Math.max(1, parseInt(inp.value||1) - 1);
    updateItem(container.dataset.pid, inp.value);
  }));

  // Manual change
  document.querySelectorAll('.cart-qty').forEach(inp => {
    inp.addEventListener('change', (e) => {
      const v = Math.max(1, parseInt(e.target.value||1));
      e.target.value = v;
      const pid = e.target.closest('[data-pid]').dataset.pid;
      updateItem(pid, v);
    });
  });

  // Update cart item (POST to server)
  async function updateItem(product_id, quantity){
    const data = new FormData();
    data.append('product_id', product_id);
    data.append('quantity', quantity);
    const res = await fetch("{% url 'update_cart_item' %}", {
      method: 'POST',
      headers: {'X-CSRFToken': csrftoken},
      body: data
    });
    const json = await res.json();
    if (!json.ok) {
      alert(json.error || 'Помилка оновлення');
      return;
    }
    // simple reload to update totals & header count
    location.reload();
  }

  // Recommended items: add to cart with quantity=1
  document.querySelectorAll('.rec-add').forEach(b => {
    b.addEventListener('click', async () => {
      const id = b.dataset.id;
      const price = b.dataset.price || 0;
      const data = new FormData();
      data.append('product_id', id);
      data.append('name', b.closest('.rec-card').querySelector('div')?.innerText || 'Товар');
      data.append('price', Math.round(parseFloat(price || 0)));
      data.append('currency', 'UAH');
      data.append('quantity', 1);
      data.append('image', b.closest('.rec-card').querySelector('img')?.src || '');
      const res = await fetch("{% url 'add_to_cart' %}", {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken},
        body: data
      });
      const json = await res.json();
      if (json.ok) {
        // update header count and reload to show item
        document.querySelectorAll('#cart-count').forEach(el => el.textContent = json.cart_count);
        location.reload();
      } else {
        alert(json.error || 'Не вдалося додати в кошик');
      }
    });
  });

  // Checkout button behavior: redirect to order_form for first_pid (server should pass 'first_pid' in context)
  const checkoutLink = document.getElementById('checkoutLink');
  // if using the JS checkout flow previously, we keep it disabled and rely on link behavior for order form.
})();
</script>
{% endblock %}