{% extends 'base.html' %}
{% load static %}

{% block head_extra %}
<style>
.fav-container { padding:36px 12px; color:var(--white); min-height:60vh; }
.fav-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); gap:16px; margin-top:18px }
.fav-card { background: rgba(255,255,255,0.02); padding:12px; border-radius:8px; text-align:center }
.fav-card img { width:100%; height:140px; object-fit:cover; border-radius:6px }
.fav-card .name { font-weight:800; color:var(--white); margin-top:8px }
.fav-card .price { color:var(--muted); margin-top:6px }
.fav-actions { display:flex; justify-content:center; gap:8px; margin-top:10px }
.btn-light-outline { padding:8px 12px; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--white); text-decoration:none }
</style>
{% endblock %}

{% block content %}
<div class="container fav-container">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h1>Обране</h1>
    <div style="color:var(--muted)">{{ products|length }} товар(ів)</div>
  </div>

  {% if products %}
    <div class="fav-grid">
      {% for p in products %}
        <div class="fav-card" data-pid="{{ p.id }}">
          {% if p.image %}
            <img src="{{ p.image.url }}" alt="{{ p.name }}">
          {% endif %}
          <div class="name">{{ p.name }}</div>
          <div class="price">{{ p.price_per_100g }} грн / 100г</div>
          <div class="fav-actions">
            <a href="{% url 'product_details' p.id %}" class="btn-light-outline">Перейти</a>
            <button class="btn-light-outline remove-fav" data-id="{{ p.id }}">Видалити</button>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p style="color:var(--muted)">Поки що нічого не додано в обране.</p>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const c = cookies[i].trim();
        if (c.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(c.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  document.querySelectorAll('.remove-fav').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      const data = new FormData();
      data.append('product_id', id);
      const res = await fetch("{% url 'toggle_favorite' %}", {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken},
        body: data
      });
      const json = await res.json();
      if (!res.ok && json && json.login_url) {
        window.location.href = json.login_url + '&next=' + encodeURIComponent(window.location.pathname);
        return;
      }
      if (json.ok) {
        // просто перезавантажимо сторінку
        location.reload();
      } else {
        alert(json.error || 'Помилка');
      }
    });
  });
})();
</script>
{% endblock %}