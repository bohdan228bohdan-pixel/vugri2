{% extends 'base.html' %}
{% load static %}

{% block title %}–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Äî {{ product.name }}{% endblock %}

{% block content %}
<form action="{% url 'submit_order' %}" method="post">
  {% csrf_token %}
  <input type="hidden" name="product_id" value="{{ product.id }}">

  <div class="checkout-wrap">
    <h1 class="checkout-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h1>
    <p class="checkout-subtitle">–û–±–µ—Ä—ñ—Ç—å —Å–ø–æ—Å—ñ–± –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</p>

    {% if error %}
      <div style="background:#3b0000;color:#ffc9c9;padding:10px;border-radius:10px;margin:12px 0">
        {{ error }}
      </div>
    {% endif %}

    <!-- –°–ª—É–∂–±–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ -->
    <div class="delivery-grid" id="deliveryGrid">
      <label class="delivery-card selected">
        <input type="radio" name="delivery_type" value="ukr_branch" checked>
        <div>
          <p class="d-title">–£–∫—Ä–ø–æ—à—Ç–∞</p>
          <p class="d-desc">–î–æ—Å—Ç–∞–≤–∫–∞ –ø—Ä–æ—Ç—è–≥–æ–º 1‚Äì3 –¥–Ω—ñ–≤</p>
          <div class="d-price">–±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ</div>
        </div>
        <div style="opacity:.9;color:var(--muted)">üìç</div>
      </label>

      <label class="delivery-card">
        <input type="radio" name="delivery_type" value="nova_branch">
        <div>
          <p class="d-title">–£ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–æ–≤–∞ –ø–æ—à—Ç–∞</p>
          <p class="d-desc">–î–æ—Å—Ç–∞–≤–∫–∞ –ø—Ä–æ—Ç—è–≥–æ–º 1‚Äì3 –¥–Ω—ñ–≤</p>
          <div class="d-price">–≤—ñ–¥ 60 –≥—Ä–Ω.</div>
        </div>
        <div style="opacity:.9;color:var(--muted)">‚ú£</div>
      </label>

      <label class="delivery-card">
        <input type="radio" name="delivery_type" value="nova_courier">
        <div>
          <p class="d-title">–ö—É—Ä'—î—Ä–æ–º –ù–æ–≤–∞ –ø–æ—à—Ç–∞</p>
          <p class="d-desc">–î–æ—Å—Ç–∞–≤–∫–∞ –ø—Ä–æ—Ç—è–≥–æ–º 1‚Äì3 –¥–Ω—ñ–≤</p>
          <div class="d-price">–≤—ñ–¥ 95 –≥—Ä–Ω.</div>
        </div>
        <div style="opacity:.9;color:var(--muted)">‚ú£</div>
      </label>
    </div>

    <!-- –î–∞–Ω—ñ –¥–æ—Å—Ç–∞–≤–∫–∏ -->
    <h2 class="section-title">–î–∞–Ω—ñ –¥–æ—Å—Ç–∞–≤–∫–∏</h2>
    <p class="section-hint">–í–≤–µ–¥—ñ—Ç—å –∞–¥—Ä–µ—Å—É –¥–æ—Å—Ç–∞–≤–∫–∏</p>

    <div class="form-grid">
      <div class="two-cols">
        <div class="form-row">
          <label for="region">–û–±–ª–∞—Å—Ç—å*</label>
          <input id="region" name="region" type="text" placeholder="–í–æ–ª–∏–Ω—Å—å–∫–∞" required>
        </div>
        <div class="form-row">
          <label for="city">–ú—ñ—Å—Ç–æ*</label>
          <input id="city" name="city" type="text" placeholder="–õ—É—Ü—å–∫" required>
        </div>
      </div>

      <!-- –î–ª—è –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è -->
      <div class="form-row" id="branchRow">
        <label for="branch">–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è / —ñ–Ω–¥–µ–∫—Å / –∞–¥—Ä–µ—Å–∞ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è*</label>
        <input id="branch" name="branch" type="text" placeholder="‚Ññ12 –∞–±–æ 45623, –≤—É–ª..." required>
      </div>

      <!-- –î–ª—è –∫—É—Ä º—î—Ä–∞ -->
      <div class="form-row" id="addressRow" style="display:none;">
        <label for="address">–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ (–≤—É–ª–∏—Ü—è, –±—É–¥–∏–Ω–æ–∫, –∫–≤.)*</label>
        <input id="address" name="address" type="text" placeholder="–≤—É–ª. –í–æ–ª–æ–¥–∏–º–∏—Ä—Å—å–∫–∞, 62">
      </div>

      <div class="two-cols">
        <div class="form-row">
          <label for="quantity">–ö—ñ–ª—å–∫—ñ—Å—Ç—å (–≥)*</label>
          <input id="quantity" name="quantity" type="number" min="100" step="100" value="100" required>
        </div>
        <div class="form-row">
          <label>–°—É–º–∞</label>
          <input type="text" value="" id="total-price-view" readonly>
        </div>
      </div>

      <!-- hidden postal for backend -->
      <input type="hidden" name="postal" id="postalHidden" value="ukr">
    </div>

    <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ñ –¥–∞–Ω—ñ -->
    <h2 class="section-title">–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ñ –¥–∞–Ω—ñ</h2>
    <p class="section-hint">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ñ –¥–∞–Ω—ñ –æ—Ç—Ä–∏–º—É–≤–∞—á–∞</p>

    <div class="form-grid">
      <div class="two-cols">
        <div class="form-row">
          <label for="first_name">–Ü–º'—è*</label>
          <input id="first_name" name="first_name" type="text" required>
        </div>
        <div class="form-row">
          <label for="last_name">–ü—Ä—ñ–∑–≤–∏—â–µ*</label>
          <input id="last_name" name="last_name" type="text" required>
        </div>
      </div>

      <div class="form-row">
        <label for="middle_name">–ü–æ –±–∞—Ç—å–∫–æ–≤—ñ*</label>
        <input id="middle_name" name="middle_name" type="text" required>
      </div>

      <div class="two-cols">
        <div class="form-row">
          <label for="email">E-mail*</label>
          <input id="email" name="email" type="email" required>
        </div>
        <div class="form-row">
          <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω*</label>
          <input id="phone" name="phone" type="tel" placeholder="+380..." required>
        </div>
      </div>

      <div style="color:var(--muted);font-size:12px">
        *–ü–æ–ª–µ –æ–±–æ–≤'—è–∑–∫–æ–≤–µ –¥–ª—è –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è
      </div>
    </div>
  </div>

  <!-- sticky bottom button -->
  <div class="checkout-bottom">
    <div class="checkout-bottom-inner">
      <button type="submit" class="big-continue">–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</button>
    </div>
  </div>
</form>
{% endblock %}

{% block scripts %}
<script>
  // highlight selected delivery card
  (function(){
    const grid = document.getElementById('deliveryGrid');
    const cards = Array.from(grid.querySelectorAll('.delivery-card'));
    const postalHidden = document.getElementById('postalHidden');
    const branchRow = document.getElementById('branchRow');
    const addressRow = document.getElementById('addressRow');
    const branchInput = document.getElementById('branch');
    const addressInput = document.getElementById('address');

    function applyDelivery(type){
      // UI select
      cards.forEach(c => c.classList.remove('selected'));
      const selected = cards.find(c => c.querySelector('input').checked);
      if (selected) selected.classList.add('selected');

      // Map to backend fields
      // ukr_branch -> postal=ukr, needs branch
      // nova_branch -> postal=nova, needs branch
      // nova_courier -> postal=nova, needs address instead of branch
      if (type === 'ukr_branch') {
        postalHidden.value = 'ukr';
        branchRow.style.display = '';
        addressRow.style.display = 'none';
        branchInput.required = true;
        addressInput.required = false;
        addressInput.value = '';
      } else if (type === 'nova_branch') {
        postalHidden.value = 'nova';
        branchRow.style.display = '';
        addressRow.style.display = 'none';
        branchInput.required = true;
        addressInput.required = false;
        addressInput.value = '';
      } else if (type === 'nova_courier') {
        postalHidden.value = 'nova';
        branchRow.style.display = 'none';
        addressRow.style.display = '';
        branchInput.required = false;
        addressInput.required = true;
        branchInput.value = '';
      }
    }

    grid.addEventListener('change', (e) => {
      if (e.target && e.target.name === 'delivery_type') {
        applyDelivery(e.target.value);
      }
    });

    // init
    const checked = grid.querySelector('input[name="delivery_type"]:checked');
    applyDelivery(checked ? checked.value : 'ukr_branch');
  })();

  // price calc
  (function(){
    const qty = document.getElementById('quantity');
    const totalView = document.getElementById('total-price-view');

    function calc(){
      const q = parseInt(qty.value||0,10);
      const price100 = parseFloat('{{ product.price_per_100g }}') || 0;
      const sum = Math.round((q/100)*price100*100)/100;
      totalView.value = sum.toFixed(2) + ' –≥—Ä–Ω';
    }
    qty.addEventListener('input', calc);
    calc();
  })();
</script>
{% endblock %}