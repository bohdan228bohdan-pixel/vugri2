{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} ‚Äî VugriUkraine{% endblock %}

{% block head_extra %}
<style>
/* Product detail scoped styles (keeps layout independent from catalog .product-card rules) */
#product-detail { padding: 28px 0; color: var(--white); }
#product-detail .inner { max-width: 1100px; margin: 0 auto; padding: 0 24px; }
#product-detail .layout { display:flex; gap:28px; flex-wrap:wrap; align-items:flex-start; justify-content:center; }

/* Image column */
#product-detail .img-col { flex:1; max-width:560px; min-width:260px; }
#product-detail .product-img-wrap { width:100%; height:420px; overflow:hidden; border-radius:12px; background:#0b0b0b; }
#product-detail .product-img { width:100%; height:100%; object-fit:cover; display:block; }

/* Thumbnails */
#product-detail .thumbs { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
#product-detail .thumb { width:56px; height:56px; border-radius:6px; overflow:hidden; cursor:pointer; border:1px solid rgba(255,255,255,0.04); background:#111; display:inline-block; }
#product-detail .thumb img { width:100%; height:100%; object-fit:cover; display:block; }

/* Info column */
#product-detail .info-col { flex:1; min-width:280px; max-width:640px; }
#product-detail h1 { margin:0 0 8px; font-weight:900; color:var(--white); }
#product-detail .product-meta { color:var(--muted); margin-bottom:12px; }

/* Price */
#product-detail .price { font-size:28px; font-weight:900; color:var(--white); margin:18px 0; }

/* Controls */
#product-detail .controls-row { display:flex; align-items:center; gap:12px; margin-top:12px; flex-wrap:wrap; }
#product-detail .qty-input { width:90px; text-align:center; background:rgba(255,255,255,0.03); color:var(--white); border:1px solid rgba(255,255,255,0.04); padding:6px; border-radius:6px; }
#product-detail .btn-add { background:var(--accent); color:#fff; border:none; padding:10px 18px; border-radius:8px; font-weight:800; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; }
#product-detail .btn-fav { display:inline-flex; align-items:center; justify-content:center; width:44px; height:44px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); color: var(--white); font-size:18px; cursor:pointer; }
#product-detail .btn-fav.favorited { background: linear-gradient(90deg,#ff4b6b,#ff2b2b); color:#fff; border-color: rgba(255,255,255,0.03); }

/* Messages */
#product-detail #product-msg { margin-top:12px; color:var(--muted); }

/* Reviews */
#product-detail .review-card { padding:12px; border-radius:8px; background:rgba(255,255,255,0.02); margin-bottom:8px; color:var(--muted); }
#product-detail .btn-action { padding:8px 12px; border-radius:8px; background:linear-gradient(90deg,#e74c3c,#ff6b57); color:#fff; border:none; font-weight:700; cursor:pointer; }

/* Responsive */
@media (max-width: 900px) {
  #product-detail .product-img-wrap { height:320px; }
  #product-detail .layout { gap:18px; }
}
</style>
{% endblock %}

{% block content %}
<div id="product-detail">
  <div class="inner">
    <div class="layout" role="main" aria-labelledby="product-title">
      <!-- Left: images -->
      <div class="img-col">
        <div class="product-img-wrap" aria-hidden="false">
          {# main image: handle several possible formats for images in context #}
          {% if images %}
            {% comment %} images may be list of url strings or objects with .url {% endcomment %}
            {% if images.0.url %}
              <img id="mainImage" src="{{ images.0.url }}" alt="{{ product.name }}" class="product-img" onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
            {% else %}
              <img id="mainImage" src="{{ images.0 }}" alt="{{ product.name }}" class="product-img" onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
            {% endif %}
          {% elif product.image and product.image.url %}
            <img id="mainImage" src="{{ product.image.url }}" alt="{{ product.name }}" class="product-img" onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
          {% else %}
            <img id="mainImage" src="{% static 'images/png/placeholder.png' %}" alt="{{ product.name }}" class="product-img">
          {% endif %}
        </div>

        <div class="thumbs" aria-hidden="false" id="thumbs">
          {% if images %}
            {% for img in images %}
              {% if img.url %}
                <div class="thumb" data-img-url="{{ img.url }}" title="{{ img.alt|default:product.name }}">
                  <img src="{{ img.url }}" alt="{{ img.alt|default:product.name }}" onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
                </div>
              {% else %}
                <div class="thumb" data-img-url="{{ img }}">
                  <img src="{{ img }}" alt="{{ product.name }}" onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
                </div>
              {% endif %}
            {% endfor %}
          {% elif product.image and product.image.url %}
            <div class="thumb" data-img-url="{{ product.image.url }}">
              <img src="{{ product.image.url }}" alt="{{ product.name }}" onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
            </div>
          {% else %}
            <div class="thumb" data-img-url="{% static 'images/png/placeholder.png' %}">
              <img src="{% static 'images/png/placeholder.png' %}" alt="placeholder">
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Right: info -->
      <div class="info-col" aria-labelledby="product-title">
        <h1 id="product-title">{{ product.name }}</h1>

        <div class="product-meta">{{ product.description }}</div>

        <div class="price">
          {% if product.price_per_100g %}
            {{ product.price_per_100g }} –≥—Ä–Ω / 100–≥
          {% else %}
            –¶—ñ–Ω–∞ —É—Ç–æ—á–Ω—é—î—Ç—å—Å—è
          {% endif %}
        </div>

        <div class="controls-row">
          <div style="display:flex;align-items:center;gap:8px">
            <button id="qty-decr" class="btn btn-outline" type="button" aria-label="decrease">‚àí</button>
            <input id="qty" class="qty-input" type="number" value="1" min="1" step="1" aria-label="quantity" />
            <button id="qty-incr" class="btn btn-outline" type="button" aria-label="increase">+</button>
          </div>

          <div style="display:flex;gap:10px;align-items:center">
            {% if user.is_authenticated %}
              <button id="addToCart" class="btn-add" data-product-id="{{ product.id }}">–î–æ –∫–æ—à–∏–∫–∞</button>
            {% else %}
              <a href="{% url 'login' %}?next={{ request.path }}" class="btn-add">–£–≤—ñ–π—Ç–∏, —â–æ–± –∫—É–ø–∏—Ç–∏</a>
            {% endif %}

            <button id="favBtn" class="btn-fav {% if is_favorited %}favorited{% endif %}" data-product-id="{{ product.id }}" title="–î–æ–¥–∞—Ç–∏ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ" aria-pressed="{% if is_favorited %}true{% else %}false{% endif %}">
              <span id="favIcon">{% if is_favorited %}‚ù§Ô∏è{% else %}ü§ç{% endif %}</span>
            </button>
          </div>
        </div>

        <div id="product-msg" aria-live="polite"></div>

        <hr style="border-color: rgba(255,255,255,0.04)">

        <h4 style="color:var(--white)">–û–ø–∏—Å</h4>
        <p style="color:var(--muted)">{{ product.description }}</p>

        <!-- Reviews -->
        <section id="reviews" style="margin-top:28px;">
          <h3 style="color:var(--white)">–í—ñ–¥–≥—É–∫–∏{% if average_rating %} ‚Äî —Å–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–π—Ç–∏–Ω–≥: {{ average_rating }}{% endif %}</h3>

          {% if user.is_authenticated %}
            <form id="reviewForm" method="post" style="margin-top:12px;" onsubmit="return false;">
              {% csrf_token %}
              <label style="color:var(--muted)">–†–µ–π—Ç–∏–Ω–≥:
                <select name="rating" id="reviewRating">
                  <option value="5">5</option>
                  <option value="4">4</option>
                  <option value="3">3</option>
                  <option value="2">2</option>
                  <option value="1">1</option>
                </select>
              </label>
              <div style="margin-top:8px;">
                <textarea name="comment" id="reviewComment" rows="3" style="width:100%;background:rgba(255,255,255,0.03);color:var(--white);border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:6px;" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å —Å–≤—ñ–π –≤—ñ–¥–≥—É–∫ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)"></textarea>
              </div>
              <div style="margin-top:8px;">
                <button id="submitReviewBtn" class="btn-action" type="button">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—ñ–¥–≥—É–∫</button>
              </div>
              <div id="reviewMsg" style="margin-top:8px;color:var(--muted)"></div>
            </form>
          {% else %}
            <p style="color:var(--muted)">–©–æ–± –∑–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫, –±—É–¥—å-–ª–∞—Å–∫–∞ <a href="{% url 'login' %}?next={{ request.path }}">—É–≤—ñ–π–¥—ñ—Ç—å</a>.</p>
          {% endif %}

          <div id="reviewsList" style="margin-top:18px;">
            {% if reviews %}
              {% for r in reviews %}
                <div class="review-card" role="article" aria-label="–í—ñ–¥–≥—É–∫ –≤—ñ–¥ {{ r.user.username }}">
                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div style="font-weight:800;color:var(--white)">{{ r.user.username }}</div>
                    <div style="color:var(--muted)">{{ r.created_at|date:"SHORT_DATETIME_FORMAT" }}</div>
                  </div>
                  <div style="margin-top:6px;color:var(--muted)">–†–µ–π—Ç–∏–Ω–≥: {{ r.rating }} / 5</div>
                  {% if r.comment %}
                    <div style="margin-top:8px;color:var(--muted)">{{ r.comment }}</div>
                  {% endif %}
                </div>
              {% endfor %}
            {% else %}
              <p style="color:var(--muted)">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –≤—ñ–¥–≥—É–∫—ñ–≤ ‚Äî –±—É–¥—å—Ç–µ –ø–µ—Ä—à–∏–º.</p>
            {% endif %}
          </div>
        </section>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  /* Scoped selectors */
  const mainImage = document.getElementById('mainImage');
  const thumbs = document.getElementById('thumbs');
  const qtyInput = document.getElementById('qty');
  const qtyIncr = document.getElementById('qty-incr');
  const qtyDecr = document.getElementById('qty-decr');
  const addBtn = document.getElementById('addToCart');
  const favBtn = document.getElementById('favBtn');
  const favIcon = document.getElementById('favIcon');
  const submitBtn = document.getElementById('submitReviewBtn');
  const reviewMsgEl = document.getElementById('reviewMsg');

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i=0;i<cookies.length;i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length+1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length+1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  /* Quantity handlers */
  if (qtyIncr && qtyDecr && qtyInput) {
    qtyIncr.addEventListener('click', () => qtyInput.value = Math.max(1, parseInt(qtyInput.value||1) + 1));
    qtyDecr.addEventListener('click', () => qtyInput.value = Math.max(1, parseInt(qtyInput.value||1) - 1));
  }

  /* Thumbnails click -> change main image, with simple active class */
  if (thumbs) {
    thumbs.querySelectorAll('.thumb').forEach(t => {
      t.addEventListener('click', () => {
        const url = t.dataset.imgUrl || (t.querySelector('img') && t.querySelector('img').src);
        if (url && mainImage) mainImage.src = url;
        thumbs.querySelectorAll('.thumb').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
      });
    });
  }

  /* Add to cart (AJAX) */
  if (addBtn) {
    addBtn.addEventListener('click', async function(){
      const pid = this.dataset.productId;
      const qty = Math.max(1, parseInt(qtyInput.value || 1));
      const data = new FormData();
      data.append('product_id', pid);
      data.append('quantity', qty);
      // safe product details
      data.append('name', '{{ product.name|escapejs }}');
      data.append('price', '{{ product.price_per_100g|default:"0" }}');
      data.append('currency', 'UAH');
      const imgSrc = mainImage ? mainImage.src : '{% static "images/png/placeholder.png" %}';
      data.append('image', imgSrc);

      this.disabled = true;
      const origText = this.textContent;
      this.textContent = '–î–æ–¥–∞—é...';
      try {
        const res = await fetch("{% url 'add_to_cart' %}", {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken},
          body: data
        });
        const json = await res.json().catch(()=>({ok:false, error:'Invalid response'}));
        if (!res.ok) {
          if (json && json.login_url) {
            window.location.href = json.login_url + '&next=' + encodeURIComponent(window.location.pathname);
            return;
          }
          document.getElementById('product-msg').textContent = json.error || '–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è';
        } else {
          if (json.ok) {
            document.getElementById('product-msg').textContent = '–î–æ–¥–∞–Ω–æ –≤ –∫–æ—à–∏–∫';
            document.querySelectorAll('#cart-count').forEach(el => el.textContent = json.cart_count);
          } else {
            document.getElementById('product-msg').textContent = json.error || '–ü–æ–º–∏–ª–∫–∞';
          }
        }
      } catch (err) {
        console.error(err);
        document.getElementById('product-msg').textContent = '–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ';
      } finally {
        this.disabled = false;
        this.textContent = origText;
      }
    });
  }

  /* Favorite toggle */
  if (favBtn) {
    favBtn.addEventListener('click', async function(){
      const pid = this.dataset.productId;
      const was = this.classList.contains('favorited');
      try {
        const res = await fetch("{% url 'toggle_favorite' %}", {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken},
          body: new URLSearchParams({product_id: pid})
        });
        const json = await res.json();
        if (!res.ok && json && json.login_url) {
          window.location.href = json.login_url + '&next=' + encodeURIComponent(window.location.pathname);
          return;
        }
        if (json.ok) {
          if (json.favorited) {
            favBtn.classList.add('favorited'); favIcon.textContent = '‚ù§Ô∏è';
          } else {
            favBtn.classList.remove('favorited'); favIcon.textContent = 'ü§ç';
          }
        } else {
          alert(json.error || '–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–∞–Ω–æ–≥–æ');
          if (was) { favBtn.classList.add('favorited'); favIcon.textContent='‚ù§Ô∏è'; } else { favBtn.classList.remove('favorited'); favIcon.textContent='ü§ç'; }
        }
      } catch (err) {
        console.error(err);
        alert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ');
      }
    });
  }

  /* Submit review (AJAX) */
  if (submitBtn) {
    submitBtn.addEventListener('click', async function(){
      const ratingEl = document.getElementById('reviewRating');
      const commentEl = document.getElementById('reviewComment');
      const rating = ratingEl ? ratingEl.value : '5';
      const comment = commentEl ? commentEl.value : '';
      submitBtn.disabled = true;
      submitBtn.textContent = '–ù–∞–¥—Å–∏–ª–∞—é...';
      reviewMsgEl.textContent = '';
      try {
        const url = "{% url 'submit_review' product.id %}";
        const res = await fetch(url, {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded'},
          body: new URLSearchParams({rating: rating, comment: comment})
        });
        const json = await res.json();
        if (!res.ok) {
          if (json && json.login_url) {
            window.location.href = json.login_url + '&next=' + encodeURIComponent(window.location.pathname);
            return;
          }
          reviewMsgEl.style.color = '#ff8a8a';
          reviewMsgEl.textContent = json.error || ('–ü–æ–º–∏–ª–∫–∞: ' + res.status);
        } else {
          reviewMsgEl.style.color = 'lightgreen';
          reviewMsgEl.textContent = json.message || '–î—è–∫—É—î–º–æ –∑–∞ –≤—ñ–¥–≥—É–∫.';
          setTimeout(()=> location.reload(), 800);
        }
      } catch (err) {
        console.error(err);
        reviewMsgEl.style.color = '#ff8080';
        reviewMsgEl.textContent = '–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ –∞–±–æ —Å–µ—Ä–≤–µ—Ä–∞ ‚Äî —Å–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—ñ–¥–≥—É–∫';
      }
    });
  }
})();
</script>
{% endblock %}