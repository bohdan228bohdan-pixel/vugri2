git config user.email "bohdan228bohdan@gmail.com"
git config user.name  "
bohdan228bohdan-pixel"
{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} ‚Äî VugriUkraine{% endblock %}

{% block head_extra %}
<style>
/* Scoped product detail styles - responsive, polished, keeps existing look */

/* Tokens */
:root{
  --page-max-width:1100px;
  --muted: #9aa0a6;
  --white: #ffffff;
  --accent: #e75b2e;
  --panel-bg: rgba(255,255,255,0.02);
  --glass: rgba(255,255,255,0.03);
  --radius: 12px;
  --shadow-strong: 0 30px 60px rgba(0,0,0,0.6);
  --thumb-size:56px;
}

/* Container */
#product-detail { padding: 28px 0; color: var(--white); }
#product-detail .inner { max-width: var(--page-max-width); margin: 0 auto; padding: 0 24px; box-sizing: border-box; }

/* Two-column layout */
#product-detail .layout {
  display: grid;
  grid-template-columns: 1fr 420px;
  gap: 28px;
  align-items: start;
}
@media (max-width: 980px) {
  #product-detail .layout { grid-template-columns: 1fr; gap: 18px; }
}

/* Gallery column */
.img-col { display:flex; flex-direction:column; gap:12px; align-items:stretch; }
.gallery-main {
  border-radius: var(--radius);
  overflow: hidden;
  background: #080808;
  box-shadow: var(--shadow-strong);
  position: relative;
  min-height: 360px;
}
.gallery-main img,
.gallery-main iframe,
.gallery-main video {
  width: 100%;
  height: 420px;
  object-fit: cover;
  display:block;
  border:0;
}
@media (max-width: 900px) { .gallery-main img, .gallery-main iframe, .gallery-main video { height: 320px; } }

/* badges (top-left) */
.gallery-badges { position:absolute; left:12px; top:12px; display:flex; gap:8px; z-index:10; }
.badge { padding:6px 8px; border-radius:8px; font-weight:900; font-size:12px; }
.badge-hit { background:#8fd19a; color:#07200b; }
.badge-video { background:#2b6fb2; color:#fff; }

/* Thumbnails */
.thumbs { display:flex; gap:10px; align-items:center; justify-content:flex-start; overflow:auto; padding-bottom:6px; -webkit-overflow-scrolling:touch; }
.thumbs::-webkit-scrollbar { height:8px; }
.thumb {
  flex: 0 0 auto;
  width: var(--thumb-size);
  height: var(--thumb-size);
  border-radius:8px;
  overflow:hidden;
  background:var(--panel-bg);
  border:2px solid transparent;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition: transform .12s ease, box-shadow .12s ease, border-color .12s;
}
.thumb img { width:100%; height:100%; object-fit:cover; display:block; }
.thumb.active { border-color: rgba(255,255,255,0.08); transform:translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,0.6); }
.thumb .play-icon { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); color:#fff; background:rgba(0,0,0,0.45); padding:6px;border-radius:6px; font-weight:800; }

/* Info column */
.info-col { min-width:280px; max-width:640px; }
#product-title { margin:0 0 8px; font-weight:900; font-size:28px; color:var(--white); }
.product-meta { color:var(--muted); margin-bottom:12px; line-height:1.5; }

/* Price */
.price { font-size:28px; font-weight:900; color:var(--white); margin:18px 0; }

/* Controls */
.controls-row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:12px; }
.qty-input { width:90px; text-align:center; background:rgba(255,255,255,0.03); color:var(--white); border:1px solid rgba(255,255,255,0.04); padding:6px; border-radius:6px; }
.btn-add { display:inline-flex; align-items:center; justify-content:center; padding:10px 18px; border-radius:8px; font-weight:800; background: linear-gradient(90deg,var(--accent), #cc4a20); color:#fff; border:0; cursor:pointer; }
.btn-outline { padding:8px 12px; border-radius:8px; background:transparent; color:var(--white); border:1px solid rgba(255,255,255,0.06); cursor:pointer; }
.btn-fav { display:inline-flex; align-items:center; justify-content:center; width:44px; height:44px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); color: var(--white); font-size:18px; cursor:pointer; }
.btn-fav.favorited { background: linear-gradient(90deg,#ff4b6b,#ff2b2b); color:#fff; border-color: rgba(255,255,255,0.03); }

/* Stock & admin toggle */
.stock-badge { padding:6px 10px; border-radius:8px; font-weight:700; color:#fff; display:inline-block; }
.stock-yes { background:#1db954; }
.stock-no { background:#d9534f; }
.toggle-stock-btn { padding:8px 12px; border-radius:8px; background:#111; color:var(--accent); border:1px solid rgba(255,255,255,0.04); cursor:pointer; }

/* Reviews */
#reviews { margin-top:28px; color:var(--muted); max-width:820px; }
#reviews h3 { color:var(--white); margin-bottom:12px; font-size:1.1rem; }
.review-card { background: var(--panel-bg); border-radius:10px; padding:12px; margin-bottom:10px; border:1px solid rgba(255,255,255,0.03); }
.review-head { display:flex; justify-content:space-between; gap:12px; align-items:center; }
.review-user { font-weight:800; color:var(--white); }
.review-time { color:var(--muted); font-size:0.85rem; }

/* Responsive */
@media (max-width: 640px) {
  .thumb { width:48px; height:48px; }
  #product-title { font-size:20px; }
  .price { font-size:22px; }
}
</style>
{% endblock %}

{% block content %}
  <div id="product-detail" class="{% if not product.in_stock %}product-out-of-stock{% endif %}">
    <div class="inner">
      <div class="layout" role="main" aria-labelledby="product-title">

        <!-- LEFT: Gallery (dynamic) -->
        <div class="img-col" aria-label="–ì–∞–ª–µ—Ä–µ—è —Ç–æ–≤–∞—Ä—É">
          <div class="gallery-main" id="galleryMain" tabindex="0" aria-live="polite">
            {# Prefer images list from view (images), else product.image, else placeholder #}
            {% if images and images.0.url %}
              {% if images.0.is_video %}
                <iframe class="product-iframe" src="{{ images.0.url }}" frameborder="0" allowfullscreen title="–í—ñ–¥–µ–æ {{ product.name }}"></iframe>
              {% else %}
                <img id="mainImage" src="{{ images.0.url }}" alt="{{ product.name }}" class="product-img"
                     onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
              {% endif %}
            {% elif product.image and product.image.url %}
              <img id="mainImage" src="{{ product.image.url }}" alt="{{ product.name }}" class="product-img"
                   onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
            {% else %}
              <img id="mainImage" src="{% static 'images/png/placeholder.png' %}" alt="{{ product.name }}" class="product-img">
            {% endif %}
            <div class="gallery-badges" aria-hidden="true">
              {% if product.youtube_url %}<span class="badge badge-video">–í—ñ–¥–µ–æ</span>{% endif %}
              {% if product.is_hit %}<span class="badge badge-hit">–•—ñ—Ç</span>{% endif %}
            </div>
          </div>

          <div class="thumbs" id="thumbs" aria-hidden="false" role="tablist" aria-label="–ú—ñ–Ω—ñ–∞—Ç—é—Ä–∏">
            {# Build thumbnails from images[] if present; otherwise show fallback single thumb #}
            {% if images %}
              {% for im in images %}
                {% if im.url %}
                  <div class="thumb{% if forloop.first %} active{% endif %}"
                       data-type="{% if im.is_video %}video{% else %}image{% endif %}"
                       data-img-url="{{ im.url }}"
                       role="tab"
                       aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
                    {% if im.is_video %}
                      <img src="{{ im.thumb_url|default:im.url }}" alt="{{ im.alt|default:product.name }}">
                      <span class="play-icon">‚ñ∂</span>
                    {% else %}
                      <img src="{{ im.url }}" alt="{{ im.alt|default:product.name }}">
                    {% endif %}
                  </div>
                {% endif %}
              {% endfor %}
            {% else %}
              {% if product.image and product.image.url %}
                <div class="thumb active" data-type="image" data-img-url="{{ product.image.url }}">
                  <img src="{{ product.image.url }}" alt="{{ product.name }}">
                </div>
              {% else %}
                <div class="thumb active" data-type="image" data-img-url="{% static 'images/png/placeholder.png' %}">
                  <img src="{% static 'images/png/placeholder.png' %}" alt="placeholder">
                </div>
              {% endif %}
            {% endif %}
          </div>
        </div>

        <!-- RIGHT: Info & Controls -->
        <div class="info-col" aria-labelledby="product-title">
          <h1 id="product-title">{{ product.name }}</h1>

          <div class="product-meta">{{ product.description }}</div>

<!-- –ù–û–í–ò–ô –ë–õ–û–ö: –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ –ø—Ä–æ–¥–∞–∂—É –≤ —à—Ç—É–∫–∞—Ö –∞–±–æ –≤ –≥—Ä–∞–º–∞—Ö -->
<div class="price">
  {% if product.sold_in_units %}
    {% if product.price_per_unit %}
      <strong>{{ product.price_per_unit|floatformat:2 }} –≥—Ä–Ω / 1 {{ product.unit_label|default:"—à—Ç" }}</strong>
    {% else %}
      <span>–¶—ñ–Ω–∞ —É—Ç–æ—á–Ω—é—î—Ç—å—Å—è</span>
    {% endif %}
  {% elif package_price %}
    {# –î–ª—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ —Ç–æ–≤–∞—Ä—É view –º–æ–∂–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç–∏ package_price/package_size –∞–±–æ –∞—Ç—Ä–∏–±—É—Ç–∏ product.package_size_grams #}
    {% if package_size %}
      <strong>{{ package_price }} –≥—Ä–Ω / {{ package_size }} –≥</strong>
    {% elif product.package_size_grams %}
      <strong>{{ product.compute_package_price|default:product.package_price_display }} –≥—Ä–Ω / {{ product.package_size_grams }} –≥</strong>
    {% elif product.package_size %}
      <strong>{{ product.package_price_display }} –≥—Ä–Ω / {{ product.package_size }} –≥</strong>
    {% else %}
      <strong>1 —à—Ç ‚Äî {{ package_price|default:product.package_price_display }}</strong>
    {% endif %}
  {% else %}
    {% if product.price_per_100g %}
      <strong>{{ product.price_per_100g|floatformat:2 }} –≥—Ä–Ω / 100–≥</strong>
    {% else %}
      <span>–¶—ñ–Ω–∞ —É—Ç–æ—á–Ω—é—î—Ç—å—Å—è</span>
    {% endif %}
  {% endif %}
</div>

<!-- –ö–Ü–ù–ï–¶–¨ –ù–û–í–û–ì–û –ë–õ–û–ö–£ -->

          <div class="controls-row" role="group" aria-label="–î—ñ—ó –∑ —Ç–æ–≤–∞—Ä–æ–º">
            <div style="display:flex;align-items:center;gap:8px">
              <button id="qty-decr" class="btn-outline" type="button" aria-label="–∑–º–µ–Ω—à–∏—Ç–∏">‚àí</button>
              <input id="qty" class="qty-input" type="number" value="1" min="1" step="1" aria-label="–∫—ñ–ª—å–∫—ñ—Å—Ç—å" />
              <button id="qty-incr" class="btn-outline" type="button" aria-label="–∑–±—ñ–ª—å—à–∏—Ç–∏">+</button>
              <button id="requestCallbackBtn" class="btn btn-outline"
        data-product-id="{{ product.id }}" data-product-name="{{ product.name }}">
  –ó–∞–º–æ–≤–∏—Ç–∏ –∑–≤–æ—Ä–æ—Ç–Ω—ñ–π –∑–≤'—è–∑–æ–∫
              </button>
            </div>

            <div style="display:flex;gap:10px;align-items:center">
              {% if user.is_authenticated %}
                <button id="addToCart" class="btn-add" data-product-id="{{ product.id }}"
                  {% if not product.in_stock %}disabled title="–¢–æ–≤–∞—Ä —Ç–∏–º—á–∞—Å–æ–≤–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π"{% endif %}>
                  {% if product.in_stock %}–î–æ –∫–æ—à–∏–∫–∞{% else %}–ù–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ{% endif %}
                </button>
              {% else %}
                <a href="{% url 'login' %}?next={{ request.path }}" class="btn-add">–£–≤—ñ–π—Ç–∏, —â–æ–± –∫—É–ø–∏—Ç–∏</a>
              {% endif %}

              <button id="favBtn" class="btn-fav {% if is_favorited %}favorited{% endif %}" data-product-id="{{ product.id }}" title="–î–æ–¥–∞—Ç–∏ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ" aria-pressed="{% if is_favorited %}true{% else %}false{% endif %}">
                <span id="favIcon">{% if is_favorited %}‚ù§Ô∏è{% else %}ü§ç{% endif %}</span>
              </button>
            </div>
          </div>

          <div style="display:flex;align-items:center;gap:12px;margin-top:12px;">
            {% if product.in_stock %}
              <span id="stockBadge" class="stock-badge stock-yes">–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</span>
            {% else %}
              <span id="stockBadge" class="stock-badge stock-no">–ù–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</span>
            {% endif %}

            {% if user.is_staff %}
              <button id="toggleStockBtn" data-product-id="{{ product.id }}" class="toggle-stock-btn">
                {% if product.in_stock %}–ü–æ—Å—Ç–∞–≤–∏—Ç–∏ —è–∫ ¬´–Ω–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ¬ª{% else %}–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –≤ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å{% endif %}
              </button>
            {% endif %}
          </div>

          <div id="product-msg" aria-live="polite" style="margin-top:12px;color:var(--muted)"></div>

          <hr style="border-color: rgba(255,255,255,0.04); margin-top:16px">

          <h4 style="color:var(--white)">–û–ø–∏—Å</h4>
          <p style="color:var(--muted)">{{ product.description }}</p>
        </div>
      </div>

      <!-- REVIEWS -->
            <section id="reviews" aria-labelledby="reviews-heading" style="margin-top:28px;">
        <h3 id="reviews-heading" style="color:var(--white)">–í—ñ–¥–≥—É–∫–∏{% if average_rating %} ‚Äî —Å–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–π—Ç–∏–Ω–≥: {{ average_rating }}{% endif %}</h3>

        {% if user.is_authenticated %}
          <form id="reviewForm" method="post" style="margin-top:12px;" onsubmit="return false;">
            {% csrf_token %}
            <label style="color:var(--muted)">–†–µ–π—Ç–∏–Ω–≥:
              <select name="rating" id="reviewRating">
                <option value="5">5</option>
                <option value="4">4</option>
                <option value="3">3</option>
                <option value="2">2</option>
                <option value="1">1</option>
              </select>
            </label>
            <div style="margin-top:8px;">
              <textarea name="comment" id="reviewComment" rows="3" style="width:100%;background:rgba(255,255,255,0.03);color:var(--white);border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:6px;" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å —Å–≤—ñ–π –≤—ñ–¥–≥—É–∫ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)"></textarea>
            </div>
            <div style="margin-top:8px;">
              <button id="submitReviewBtn" class="btn-outline" type="button">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—ñ–¥–≥—É–∫</button>
            </div>
            <div id="reviewMsg" style="margin-top:8px;color:var(--muted)"></div>
          </form>
        {% else %}
          <p style="color:var(--muted)">–©–æ–± –∑–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫, –±—É–¥—å-–ª–∞—Å–∫–∞ <a href="{% url 'login' %}?next={{ request.path }}">—É–≤—ñ–π–¥—ñ—Ç—å</a>.</p>
        {% endif %}

        <div id="reviewsList" style="margin-top:18px;">
          {% if reviews %}
            {% for r in reviews %}
              <div id="review-{{ r.id }}" class="review-card" role="article" aria-label="–í—ñ–¥–≥—É–∫ –≤—ñ–¥ {{ r.user.username }}" style="position:relative;padding:12px;border-bottom:1px solid rgba(255,255,255,0.03);margin-bottom:8px;">
                <div class="review-head" style="display:flex;justify-content:space-between;align-items:center;">
                  <div>
                    <div class="review-user" style="font-weight:700;color:#fff">{{ r.user.username }}</div>
                    <div class="review-time" style="color:var(--muted);font-size:13px">{{ r.created_at|date:"SHORT_DATETIME_FORMAT" }}</div>
                  </div>

                  {# Delete button for VugriUa only (visible in UI only for that account) #}
                  {% if user.is_authenticated and user.username == 'VugriUa' %}
                    <div style="margin-left:12px;">
                      <button
                        type="button"
                        class="delete-review-btn btn-outline"
                        data-review-id="{{ r.id }}"
                        data-delete-url="{% url 'delete_review' r.id %}"
                        style="padding:6px 10px;border-radius:6px;"
                        title="–í–∏–¥–∞–ª–∏—Ç–∏ –≤—ñ–¥–≥—É–∫">
                        –í–∏–¥–∞–ª–∏—Ç–∏
                      </button>
                    </div>
                  {% endif %}
                </div>

                <div style="margin-top:8px;color:var(--muted)">–†–µ–π—Ç–∏–Ω–≥: {{ r.rating }} / 5</div>
                {% if r.comment %}
                  <div style="margin-top:8px;color:var(--muted)">{{ r.comment }}</div>
                {% endif %}
              </div>
            {% endfor %}
          {% else %}
            <p style="color:var(--muted)">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –≤—ñ–¥–≥—É–∫—ñ–≤ ‚Äî –±—É–¥—å—Ç–µ –ø–µ—Ä—à–∏–º.</p>
          {% endif %}
        </div>
      </section>


    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Helper —Å–µ–ª–µ–∫—Ç–æ—Ä–∏
  function q(sel, ctx=document){ return ctx.querySelector(sel); }
  function qa(sel, ctx=document){ return Array.from((ctx || document).querySelectorAll(sel)); }

  // CSRF helper
  function getCookie(name){
    const v = document.cookie.split('; ').find(c=>c.trim().startsWith(name+'='));
    return v ? decodeURIComponent(v.split('=')[1]) : null;
  }
  const csrftoken = getCookie('csrftoken');

  // Elements (flexible: support both mediaContainer and galleryMain)
  const mediaContainer = q('#mediaContainer') || q('#galleryMain') || q('.gallery-main');
  const thumbsWrap = q('#thumbs') || q('#galleryThumbs') || q('.thumbs');

  // Other controls (unchanged)
  const qtyInput = q('#qty');
  const qtyIncr = q('#qty-incr');
  const qtyDecr = q('#qty-decr');
  const addBtn = q('#addToCart');
  const favBtn = q('#favBtn');
  const favIcon = q('#favIcon');
  const submitBtn = q('#submitReviewBtn');
  const reviewMsgEl = q('#reviewMsg');
  const toggleBtn = q('#toggleStockBtn');
  const stockBadge = q('#stockBadge');

  // Quantity handlers
  if (qtyIncr && qtyDecr && qtyInput) {
    qtyIncr.addEventListener('click', ()=> qtyInput.value = Math.max(1, parseInt(qtyInput.value||1) + 1));
    qtyDecr.addEventListener('click', ()=> qtyInput.value = Math.max(1, parseInt(qtyInput.value||1) - 1));
  }

  // ------- Gallery handling (robust) -------
  if (mediaContainer && thumbsWrap) {
    // find thumbnail items (support .thumb and .thumb-btn fallbacks)
    const thumbs = qa('.thumb, .thumb-btn', thumbsWrap);

    // Ensure at least one active thumb
    if (thumbs.length && !thumbs.some(t => t.classList.contains('active'))) thumbs[0].classList.add('active');

    // safe extract youtube id
    function extractYouTubeId(url){
      if(!url) return null;
      const patterns = [
        /(?:v=)([0-9A-Za-z_-]{11})/,
        /(?:embed\/)([0-9A-Za-z_-]{11})/,
        /(?:youtu\.be\/)([0-9A-Za-z_-]{11})/,
        /(?:shorts\/)([0-9A-Za-z_-]{11})/
      ];
      for(const re of patterns){
        const m = url.match(re);
        if(m && m[1]) return m[1];
      }
      const any = url.match(/([0-9A-Za-z_-]{11})/);
      return any ? any[1] : null;
    }

    // show image in main container
    function showImage(src, alt){
      try {
        mediaContainer.innerHTML = '';
        const img = document.createElement('img');
        img.className = 'product-img';
        img.src = src;
        img.alt = alt || '';
        img.loading = 'lazy';
        img.onerror = function(){ this.onerror=null; this.src = '{% static "images/png/placeholder.png" %}'; };
        mediaContainer.appendChild(img);
      } catch(e) { console.error('showImage error', e); }
    }

    // show embedded iframe (use only when you know embed is allowed)
    function embedYouTube(vid){
      try {
        mediaContainer.innerHTML = '';
        const iframe = document.createElement('iframe');
        iframe.className = 'product-iframe';
        iframe.src = 'https://www.youtube.com/embed/' + vid + '?rel=0&modestbranding=1';
        iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
        iframe.allowFullscreen = true;
        iframe.frameBorder = 0;
        mediaContainer.appendChild(iframe);
      } catch(e){ console.error('embedYouTube error', e); window.open('https://youtu.be/' + vid, '_blank'); }
    }

    // fallback: open YouTube (safe when embedding is disallowed)
    function openYouTube(vid){
      window.open('https://youtu.be/' + vid, '_blank');
    }

    // Decide what to do when video thumb clicked.
    // DEFAULT_BEHAVIOR = 'open' -> open youtube in new tab (safe)
    // set to 'embed' to attempt inline embed (may show player error if owner disallows embedding)
    const DEFAULT_VIDEO_BEHAVIOR = 'open'; // 'open' or 'embed'

    function handleVideoClick(url){
      const vid = extractYouTubeId(url);
      if(!vid){ window.open(url || '#', '_blank'); return; }
      if (DEFAULT_VIDEO_BEHAVIOR === 'embed') embedYouTube(vid);
      else openYouTube(vid);
    }

    // Attach handlers to thumbs
    thumbs.forEach(function(t){
      t.tabIndex = t.tabIndex || 0; // make focusable
      t.addEventListener('click', function(e){
        e.preventDefault();
        // read dataset keys flexibly
        const type = (t.dataset.type || t.getAttribute('data-type') || 'image').toLowerCase();
        const imgUrl = t.dataset.imgUrl || t.getAttribute('data-img-url') || t.dataset.src || t.getAttribute('data-src');
        const videoUrl = t.dataset.videoUrl || t.getAttribute('data-video-url') || t.dataset.src || t.getAttribute('data-src');

        // update active state
        thumbs.forEach(x => x.classList.remove('active'));
        t.classList.add('active');

        if (type === 'video') {
          handleVideoClick(videoUrl || imgUrl);
        } else {
          if (imgUrl) showImage(imgUrl, t.getAttribute('alt') || '');
        }
      });

      // keyboard accessibility: Enter / Space activates
      t.addEventListener('keydown', function(e){
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); this.click(); }
      });
    });

    // If initial main is placeholder and first thumb exists, show first thumb content
    try {
      const mainHasImg = !!(mediaContainer.querySelector && mediaContainer.querySelector('img, iframe, video'));
      if(!mainHasImg && thumbs.length){
        const first = thumbs[0];
        const type = (first.dataset.type || first.getAttribute('data-type') || 'image').toLowerCase();
        const imgUrl = first.dataset.imgUrl || first.getAttribute('data-img-url') || first.dataset.src || first.getAttribute('data-src');
        const videoUrl = first.dataset.videoUrl || first.getAttribute('data-video-url') || first.dataset.src || first.getAttribute('data-src');
        if(type === 'video') handleVideoClick(videoUrl || imgUrl);
        else if(imgUrl) showImage(imgUrl, first.getAttribute('alt') || '');
      }
    } catch(e){ /* non-critical */ }
  } // end gallery

  // ------- Add to cart (unchanged behaviour, robustified) -------
if (addBtn) {
  addBtn.addEventListener('click', async function(){
    const pid = this.dataset.productId;
    const qty = Math.max(1, parseInt(qtyInput.value || 1));
    const data = new URLSearchParams();
    data.append('product_id', pid);
    data.append('quantity', qty);
    data.append('currency', 'UAH');
    const currentImg = mediaContainer && mediaContainer.querySelector('img') ? mediaContainer.querySelector('img').src : '{% static "images/png/placeholder.png" %}';
    data.append('image', currentImg);
    data.append('name', '{{ product.name|escapejs }}');

    this.disabled = true;
    const origText = this.textContent;
    this.textContent = '–î–æ–¥–∞—é...';

    try {
      const res = await fetch("{% url 'add_to_cart' %}", {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest'},
        body: data,
        credentials: 'same-origin'
      });

      // –ë–µ–∑–ø–µ—á–Ω–µ —á–∏—Ç–∞–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
      const ct = res.headers.get('content-type') || '';
      let json = null;
      if (ct.includes('application/json')) {
        try {
          json = await res.json();
        } catch (e) {
          const text = await res.text();
          console.error('Invalid JSON response:', text);
          alert('–°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω—É JSON –≤—ñ–¥–ø–æ–≤—ñ–¥—å. –ü–æ–¥–∏–≤—ñ—Ç—å—Å—è –∫–æ–Ω—Å–æ–ª—å.');
          return;
        }
      } else {
        // –°–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–≤–µ—Ä–Ω—É–≤ JSON ‚Äî –ø–æ–∫–∞–∂–µ–º–æ —Ç–µ–∫—Å—Ç –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        const text = await res.text();
        console.error('Non-JSON response from add_to_cart:', text);
        alert('–ü–æ–º–∏–ª–∫–∞: —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –Ω–µ–æ—á—ñ–∫—É–≤–∞–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å Network/Response.');
        return;
      }

      // –¢–µ–ø–µ—Ä –æ–±—Ä–æ–±–ª—è—î–º–æ JSON
      if (!res.ok) {
        if (json && json.login_url) { window.location.href = json.login_url + '&next=' + encodeURIComponent(window.location.pathname); return; }
        q('#product-msg').textContent = json.error || ('–ü–æ–º–∏–ª–∫–∞: ' + res.status);
      } else {
        if (json.ok) {
          q('#product-msg').textContent = '–î–æ–¥–∞–Ω–æ –≤ –∫–æ—à–∏–∫';
          qa('#cart-count').forEach(el => el.textContent = json.cart_count);
        } else {
          q('#product-msg').textContent = json.error || '–ü–æ–º–∏–ª–∫–∞';
        }
      }
    } catch (err) {
      console.error('Network error:', err);
      q('#product-msg').textContent = '–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ';
    } finally {
      this.disabled = false;
      this.textContent = origText;
    }
  });
}

  // ------- Favorite, Review, Toggle availability (kept as in your code) -------
  if (favBtn) {
    favBtn.addEventListener('click', async function(){
      const pid = this.dataset.productId;
      if(!pid) return;
      this.disabled = true;
      try{
        const res = await fetch("{% url 'toggle_favorite' %}", {
          method:'POST',
          headers: {'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With':'XMLHttpRequest'},
          body: new URLSearchParams({product_id: pid}),
          credentials: 'same-origin'
        });
        const json = await res.json().catch(()=>({ok:false}));
        if(!res.ok && json && json.login_url){ window.location = json.login_url + '&next=' + encodeURIComponent(window.location.pathname); return; }
        if(json.ok){
          if(json.favorited){ favBtn.classList.add('favorited'); if(favIcon) favIcon.textContent='‚ù§Ô∏è'; favBtn.setAttribute('aria-pressed','true'); }
          else { favBtn.classList.remove('favorited'); if(favIcon) favIcon.textContent='ü§ç'; favBtn.setAttribute('aria-pressed','false'); }
        } else alert(json.error || '–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –æ–±—Ä–∞–Ω–µ');
      } catch(e){ console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ'); }
      finally{ favBtn.disabled = false; }
    });
  }

  if (submitBtn) {
    submitBtn.addEventListener('click', async function(){
      const rating = q('#reviewRating') ? q('#reviewRating').value : '5';
      const comment = q('#reviewComment') ? q('#reviewComment').value.trim() : '';
      submitBtn.disabled = true;
      const orig = submitBtn.textContent;
      submitBtn.textContent = '–ù–∞–¥—Å–∏–ª–∞—é...';
      reviewMsgEl.textContent = '';
      try{
        const res = await fetch("{% url 'submit_review' product.id %}", {
          method:'POST',
          headers:{ 'X-CSRFToken': csrftoken, 'Content-Type':'application/x-www-form-urlencoded', 'X-Requested-With':'XMLHttpRequest' },
          body: new URLSearchParams({ rating: rating, comment: comment }),
          credentials: 'same-origin'
        });
        const json = await res.json();
        if(!res.ok){ if(json && json.login_url){ window.location = json.login_url + '&next=' + encodeURIComponent(window.location.pathname); return; } reviewMsgEl.style.color='#ff8a8a'; reviewMsgEl.textContent = json.error || ('–ü–æ–º–∏–ª–∫–∞: ' + res.status); }
        else { if(json.ok){ reviewMsgEl.style.color='lightgreen'; reviewMsgEl.textContent = json.message || '–î—è–∫—É—î–º–æ –∑–∞ –≤—ñ–¥–≥—É–∫.'; setTimeout(()=> location.reload(), 800); } else { reviewMsgEl.style.color='#ff8a8a'; reviewMsgEl.textContent = json.error || '–ù–µ –≤–¥–∞–ª–æ—Å—è –¥–æ–¥–∞—Ç–∏ –≤—ñ–¥–≥—É–∫.'; } }
      } catch(e){ console.error(e); reviewMsgEl.style.color='#ff8080'; reviewMsgEl.textContent='–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ'; }
      finally{ submitBtn.disabled = false; submitBtn.textContent = orig; }
    });
  }

  if (toggleBtn){
    toggleBtn.addEventListener('click', async function(){
      if(!confirm('–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–º—ñ–Ω—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ —Ç–æ–≤–∞—Ä—É?')) return;
      const pid = this.dataset.productId;
      const base = "{% url 'toggle_availability' 0 %}";
      const url = base.replace('/0/', '/' + pid + '/');
      try{
        const res = await fetch(url, { method:'POST', headers:{ 'X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest' }, credentials:'same-origin' });
        if(!res.ok) throw new Error('network');
        const js = await res.json();
        if(js.ok){
          if(js.in_stock){ stockBadge.textContent='–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ'; stockBadge.classList.remove('stock-no'); stockBadge.classList.add('stock-yes'); toggleBtn.textContent='–ü–æ—Å—Ç–∞–≤–∏—Ç–∏ —è–∫ ¬´–Ω–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ¬ª'; }
          else { stockBadge.textContent='–ù–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ'; stockBadge.classList.remove('stock-yes'); stockBadge.classList.add('stock-no'); toggleBtn.textContent='–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –≤ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å'; }
        } else alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å');
      }catch(e){ console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ –∞–±–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É.'); }
    });
  }

}); // DOMContentLoaded
        function getCookie(name) {
          const v = document.cookie.split('; ').find(c => c.trim().startsWith(name + '='));
          return v ? decodeURIComponent(v.split('=')[1]) : null;
        }
        const csrftoken = getCookie('csrftoken');

        // Attach AJAX delete handlers to buttons rendered for VugriUa
        document.querySelectorAll('.delete-review-btn').forEach(btn => {
          btn.addEventListener('click', async function (e) {
            e.preventDefault();
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –≤—ñ–¥–≥—É–∫?')) return;
            const reviewId = this.dataset.reviewId;
            const url = this.dataset.deleteUrl;
            this.disabled = true;
            const origText = this.textContent;
            this.textContent = '–í–∏–¥–∞–ª—è—é...';
            try {
              const res = await fetch(url, {
                method: 'POST',
                headers: {
                  'X-CSRFToken': csrftoken,
                  'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
              });
              if (res.ok) {
                const json = await res.json().catch(() => null);
                if (json && json.ok) {
                  // remove element from DOM
                  const el = document.getElementById('review-' + reviewId);
                  if (el) el.remove();
                } else {
                  alert((json && json.error) ? json.error : '–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—ñ–¥–≥—É–∫.');
                  this.disabled = false;
                  this.textContent = origText;
                }
              } else {
                if (res.status === 403) alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤ –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è.');
                else alert('–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + res.status);
                this.disabled = false;
                this.textContent = origText;
              }
            } catch (err) {
              console.error(err);
              alert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ ‚Äî —Å–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.');
              this.disabled = false;
              this.textContent = origText;
            }
          });
        });
</script>

<!-- CALLBACK modal (insert before the template's {% endblock %}) -->
<div id="callbackModal" class="callback-modal" style="display:none;">
  <div class="callback-modal-inner" role="dialog" aria-modal="true" aria-labelledby="cbTitle">
    <h3 id="cbTitle">–ó–∞–º–æ–≤–∏—Ç–∏ –∑–≤–æ—Ä–æ—Ç–Ω—ñ–π –∑–≤'—è–∑–æ–∫</h3>
    <form id="callbackForm" method="post">
      {% csrf_token %}
      <input type="hidden" name="product" id="cb_product" value="{{ product.id }}">
      <div>
        <label>–¢–µ–ª–µ—Ñ–æ–Ω *</label>
        <input type="text" name="phone" id="cb_phone" placeholder="+380XXXXXXXXX" required>
      </div>
      <div>
        <label>–Ü–º'—è</label>
        <input type="text" name="name" id="cb_name" placeholder="–í–∞—à–µ —ñ–º'—è (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)">
      </div>
      <div>
        <label>–ó—Ä—É—á–Ω–∏–π —á–∞—Å</label>
        <input type="text" name="preferred_time" id="cb_time" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –∑–∞–≤—Ç—Ä–∞ –ø—ñ—Å–ª—è 18:00">
      </div>
      <div>
        <label>–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</label>
        <textarea name="message" id="cb_message" rows="3" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—à—ñ—Ç—å –∑–∞–ø–∏—Ç"></textarea>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <button type="submit" class="btn btn-primary" id="cbSendBtn">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
        <button type="button" class="btn btn-outline" id="cbCancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <a href="tel:+380986666466" class="btn btn-outline" style="margin-left:auto">–ü–æ–¥–∑–≤–æ–Ω–∏—Ç–∏</a>
      </div>

      <div id="cbResult" style="margin-top:10px;display:none;"></div>
    </form>
  </div>
</div>

<style>
.callback-modal { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:2000; display:flex; align-items:center; justify-content:center; padding:20px; }
.callback-modal-inner { background:#fff; color:#111; padding:18px; border-radius:8px; width:100%; max-width:540px; box-shadow:0 10px 40px rgba(0,0,0,0.4); }
.callback-modal input, .callback-modal textarea { width:100%; padding:8px; margin-top:6px; border:1px solid #ddd; border-radius:6px; }
</style>

<script>
(function(){
  const openBtn = document.getElementById('requestCallbackBtn');
  const modal = document.getElementById('callbackModal');
  const cancelBtn = document.getElementById('cbCancel');
  const form = document.getElementById('callbackForm');
  const resultBox = document.getElementById('cbResult');
  const sendBtn = document.getElementById('cbSendBtn');

  if (!openBtn || !modal || !form) return;

  function openModal(productId){
    const hid = modal.querySelector('#cb_product');
    if (hid && productId) hid.value = productId;
    resultBox.style.display = 'none';
    modal.style.display = 'flex';
  }
  function closeModal(){ modal.style.display = 'none'; }

  openBtn.addEventListener('click', function(e){
    e.preventDefault();
    openModal(this.dataset.productId || '{{ product.id }}');
  });
  cancelBtn.addEventListener('click', function(e){ e.preventDefault(); closeModal(); });

  function getCsrfToken(){
    const el = form.querySelector('[name=csrfmiddlewaretoken]');
    return el ? el.value : '';
  }

  form.addEventListener('submit', function(ev){
    ev.preventDefault();
    sendBtn.disabled = true;
    resultBox.style.display = 'none';
    const data = new FormData(form);

    fetch("{% url 'request_callback' %}", {
      method: "POST",
      headers: { 'X-CSRFToken': getCsrfToken(), 'X-Requested-With': 'XMLHttpRequest' },
      body: data,
      credentials: 'same-origin'
    }).then(async res => {
      const json = await res.json().catch(()=>null);
      if (res.ok && json && json.ok){
        resultBox.style.color = 'green';
        resultBox.textContent = json.message || '–î—è–∫—É—î–º–æ! –ú–∏ –∑–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É—î–º–æ.';
        resultBox.style.display = 'block';
        form.reset();
        setTimeout(closeModal, 1700);
      } else {
        resultBox.style.color = 'red';
        resultBox.textContent = (json && (json.error || JSON.stringify(json.errors))) || '–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏';
        resultBox.style.display = 'block';
      }
    }).catch(err=>{
      resultBox.style.color = 'red';
      resultBox.textContent = '–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.';
      resultBox.style.display = 'block';
      console.error(err);
    }).finally(()=>{ sendBtn.disabled = false; });
  });

  // close when clicking outside dialog
  modal.addEventListener('click', function(e){
    if (e.target === modal) closeModal();
  });
})();
</script>
{% endblock %}
