{% extends 'base.html' %}
{% load static %}

{% block head_extra %}
<style>
.product-page { padding: 28px 0; color:var(--white) }
.product-img-wrap { max-width: 560px; max-height: 560px; overflow:hidden; border-radius:12px; background:#faf9f6; }
.product-img { display:block; width:100%; height:100%; object-fit:contain; }
.thumbs { margin-top:10px; display:flex; gap:8px; }
.thumb { width:56px; height:56px; border-radius:6px; overflow:hidden; cursor:pointer; border:1px solid rgba(0,0,0,0.06); background:#fff }
.qty-input { width:90px; text-align:center; background:rgba(255,255,255,0.03); color:var(--white); border:1px solid rgba(255,255,255,0.04); padding:6px; border-radius:6px }
.btn-add { background:linear-gradient(90deg,var(--accent-red),#ff6b57); color:#fff; border:none; padding:10px 18px; border-radius:8px; font-weight:800 }
.btn-fav {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:44px;
  height:44px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.06);
  background: rgba(255,255,255,0.02);
  color: var(--white);
  font-size:18px;
  cursor:pointer;
}
.btn-fav.favorited { background: linear-gradient(90deg,#ff4b6b,#ff2b2b); color:#fff; border-color: rgba(255,255,255,0.03) }
.controls-row { display:flex; align-items:center; gap:12px; margin-top:12px; flex-wrap:wrap; }
.price { font-size:28px;font-weight:900;color:var(--white);margin:18px 0; }
.product-meta { color:var(--muted) }
</style>
{% endblock %}

{% block content %}
<div class="container product-page">
  <div class="row" style="display:flex;gap:24px;align-items:flex-start">
    <div style="flex:1;max-width:560px">
      <div class="product-img-wrap">
        <img id="mainImage" src="{{ product.image.url }}" alt="{{ product.name }}" class="product-img">
      </div>
      <div class="thumbs" aria-hidden="false">
        <div class="thumb"><img src="{{ product.image.url }}" alt=""></div>
      </div>
    </div>

    <div style="flex:1;min-width:280px">
      <h1 style="font-weight:900;color:var(--white)">{{ product.name }}</h1>
      <div class="product-meta">{{ product.description }}</div>

      <div class="price">{{ product.price_per_100g }} –≥—Ä–Ω / 100–≥</div>

      <div class="controls-row">
        <div style="display:flex;align-items:center;gap:8px">
          <button id="qty-decr" class="btn btn-outline-light" type="button" aria-label="decrease">‚àí</button>
          <input id="qty" class="qty-input" type="number" value="1" min="1" step="1" aria-label="quantity" />
          <button id="qty-incr" class="btn btn-outline-light" type="button" aria-label="increase">+</button>
        </div>

        <div style="display:flex;gap:10px;align-items:center">
          {% if user.is_authenticated %}
            <button id="addToCart" class="btn-add" data-product-id="{{ product.id }}">–î–æ –∫–æ—à–∏–∫–∞</button>
          {% else %}
            <a href="{% url 'login' %}?next={{ request.path }}" class="btn-add">–£–≤—ñ–π—Ç–∏, —â–æ–± –∫—É–ø–∏—Ç–∏</a>
          {% endif %}

          <button id="favBtn" class="btn-fav {% if is_favorited %}favorited{% endif %}" data-product-id="{{ product.id }}" title="–î–æ–¥–∞—Ç–∏ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ" aria-pressed="{% if is_favorited %}true{% else %}false{% endif %}">
            <span id="favIcon">{% if is_favorited %}‚ù§Ô∏è{% else %}ü§ç{% endif %}</span>
          </button>
        </div>
      </div>

      <div id="product-msg" style="margin-top:12px;color:var(--muted)"></div>

      <hr style="border-color: rgba(255,255,255,0.04)">
      <h4 style="color:var(--white)">–û–ø–∏—Å</h4>
      <p style="color:var(--muted)">{{ product.description }}</p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // Quantity controls
  const qtyInput = document.getElementById('qty');
  document.getElementById('qty-incr').addEventListener('click', () => qtyInput.value = Math.max(1, parseInt(qtyInput.value||1) + 1));
  document.getElementById('qty-decr').addEventListener('click', () => qtyInput.value = Math.max(1, parseInt(qtyInput.value||1) - 1));

  // Thumbnail click -> change main image
  document.querySelectorAll('.thumb').forEach(t => t.addEventListener('click', () => {
    const img = t.querySelector('img');
    if (img) document.getElementById('mainImage').src = img.src;
  }));

  // Add to cart
  const addBtn = document.getElementById('addToCart');
  if (addBtn){
    addBtn.addEventListener('click', async function(){
      const btn = this;
      const pid = btn.dataset.productId;
      const qty = Math.max(1, parseInt(qtyInput.value || 1));

      const data = new FormData();
      data.append('product_id', pid);
      data.append('name', '{{ product.name|escapejs }}');
      data.append('price', Math.round(parseFloat('{{ product.price_per_100g }}' || '0')));
      data.append('currency', 'UAH');
      data.append('quantity', qty);
      data.append('image', '{{ product.image.url }}');

      btn.disabled = true;
      btn.textContent = '–î–æ–¥–∞—é...';
      try {
        const res = await fetch("{% url 'add_to_cart' %}", {
          method: 'POST',
          headers: { 'X-CSRFToken': csrftoken },
          body: data
        });

        const json = await res.json();

        // If server asks to login -> redirect
        if (!res.ok && json && json.login_url) {
          window.location.href = json.login_url + '&next=' + encodeURIComponent(window.location.pathname);
          return;
        }

        if (json.ok) {
          document.getElementById('product-msg').textContent = '–î–æ–¥–∞–Ω–æ –≤ –∫–æ—à–∏–∫';
          document.querySelectorAll('#cart-count').forEach(el => el.textContent = json.cart_count);
        } else {
          document.getElementById('product-msg').textContent = json.error || '–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è';
        }
      } catch (err) {
        document.getElementById('product-msg').textContent = '–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ';
      } finally {
        btn.disabled = false;
        btn.textContent = '–î–æ –∫–æ—à–∏–∫–∞';
      }
    });
  }

  // Favorite toggle
  const favBtn = document.getElementById('favBtn');
  const favIcon = document.getElementById('favIcon');
  if (favBtn) {
    favBtn.addEventListener('click', async function(){
      const pid = this.dataset.productId;
      const data = new FormData();
      data.append('product_id', pid);

      // Optimistic UI change
      const wasFavorited = favBtn.classList.contains('favorited');

      try {
        const res = await fetch("{% url 'toggle_favorite' %}", {
          method: 'POST',
          headers: { 'X-CSRFToken': csrftoken },
          body: data
        });
        const json = await res.json();

        // If server asks to login -> redirect
        if (!res.ok && json && json.login_url) {
          window.location.href = json.login_url + '&next=' + encodeURIComponent(window.location.pathname);
          return;
        }

        if (json.ok) {
          if (json.favorited) {
            favBtn.classList.add('favorited');
            favIcon.textContent = '‚ù§Ô∏è';
            favBtn.setAttribute('aria-pressed','true');
          } else {
            favBtn.classList.remove('favorited');
            favIcon.textContent = 'ü§ç';
            favBtn.setAttribute('aria-pressed','false');
          }
        } else {
          alert(json.error || '–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –æ–±—Ä–∞–Ω–æ–≥–æ');
          // revert if optimistic changed
          if (wasFavorited) { favBtn.classList.add('favorited'); favIcon.textContent='‚ù§Ô∏è'; }
          else { favBtn.classList.remove('favorited'); favIcon.textContent='ü§ç'; }
        }
      } catch (err) {
        alert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ');
      }
    });
  }
})();
</script>
{% endblock %}