{% extends 'base.html' %}
{% load static %}

{% block head_extra %}
<style>
/* Product page styles (dark theme) */
.product-page { padding: 28px 0; color:var(--white); }
.product-img-wrap { max-width: 560px; height:420px; overflow:hidden; border-radius:12px; background:#0b0b0b; }
.product-img { width:100%; height:100%; object-fit:cover; display:block; }
.thumbs { margin-top:10px; display:flex; gap:8px; }
.thumb { width:56px; height:56px; border-radius:6px; overflow:hidden; cursor:pointer; border:1px solid rgba(0,0,0,0.06); background:#fff; }
.thumb img { width:100%; height:100%; object-fit:cover; display:block; }
.qty-input { width:90px; text-align:center; background:rgba(255,255,255,0.03); color:var(--white); border:1px solid rgba(255,255,255,0.04); padding:6px; border-radius:6px; }
.btn-add { background:linear-gradient(90deg,var(--accent-red),#ff6b57); color:#fff; border:none; padding:10px 18px; border-radius:8px; font-weight:800; }
.btn-fav { display:inline-flex; align-items:center; justify-content:center; width:44px; height:44px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); color: var(--white); font-size:18px; cursor:pointer; }
.btn-fav.favorited { background: linear-gradient(90deg,#ff4b6b,#ff2b2b); color:#fff; border-color: rgba(255,255,255,0.03); }
.controls-row { display:flex; align-items:center; gap:12px; margin-top:12px; flex-wrap:wrap; }
.price { font-size:28px; font-weight:900; color:var(--white); margin:18px 0; }
.product-meta { color:var(--muted); }
.review-card { padding:12px; border-radius:8px; background:rgba(255,255,255,0.02); margin-bottom:8px; }
.btn-action { padding:8px 12px; border-radius:8px; background:linear-gradient(90deg,#e74c3c,#ff6b57); color:#fff; border:none; font-weight:700; }
@media (max-width:900px) {
  .product-img-wrap { height:320px; }
}
</style>
{% endblock %}

{% block content %}
<div class="container product-page">
  <div class="row" style="display:flex;gap:24px;align-items:flex-start">
    <div style="flex:1;max-width:560px">
      <div class="product-img-wrap" aria-hidden="false">
        {% if product.image and product.image.url %}
          <img id="mainImage" src="{{ product.image.url }}" alt="{{ product.name }}" class="product-img" onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
        {% else %}
          <img id="mainImage" src="{% static 'images/png/placeholder.png' %}" alt="{{ product.name }}" class="product-img">
        {% endif %}
      </div>

      <div class="thumbs" aria-hidden="false">
        {% if product.image and product.image.url %}
          <div class="thumb"><img src="{{ product.image.url }}" alt="{{ product.name }}" onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';"></div>
        {% else %}
          <div class="thumb"><img src="{% static 'images/png/placeholder.png' %}" alt=""></div>
        {% endif %}
      </div>
    </div>

    <div style="flex:1;min-width:280px">
      <h1 style="font-weight:900;color:var(--white)">{{ product.name }}</h1>
      <div class="product-meta">{{ product.description }}</div>

      <div class="price">{{ product.price_per_100g }} –≥—Ä–Ω / 100–≥</div>

      <div class="controls-row">
        <div style="display:flex;align-items:center;gap:8px">
          <button id="qty-decr" class="btn btn-outline-light" type="button" aria-label="decrease">‚àí</button>
          <input id="qty" class="qty-input" type="number" value="1" min="1" step="1" aria-label="quantity" />
          <button id="qty-incr" class="btn btn-outline-light" type="button" aria-label="increase">+</button>
        </div>

        <div style="display:flex;gap:10px;align-items:center">
          {% if user.is_authenticated %}
            <button id="addToCart" class="btn-add" data-product-id="{{ product.id|default:'' }}">–î–æ –∫–æ—à–∏–∫–∞</button>
          {% else %}
            <a href="{% url 'login' %}?next={{ request.path }}" class="btn-add">–£–≤—ñ–π—Ç–∏, —â–æ–± –∫—É–ø–∏—Ç–∏</a>
          {% endif %}

          <button id="favBtn" class="btn-fav {% if is_favorited %}favorited{% endif %}" data-product-id="{{ product.id|default:'' }}" title="–î–æ–¥–∞—Ç–∏ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ" aria-pressed="{% if is_favorited %}true{% else %}false{% endif %}">
            <span id="favIcon">{% if is_favorited %}‚ù§Ô∏è{% else %}ü§ç{% endif %}</span>
          </button>
        </div>
      </div>

      <div id="product-msg" style="margin-top:12px;color:var(--muted)"></div>

      <hr style="border-color: rgba(255,255,255,0.04)">
      <h4 style="color:var(--white)">–û–ø–∏—Å</h4>
      <p style="color:var(--muted)">{{ product.description }}</p>

      <!-- Reviews -->
      <section id="reviews" style="margin-top:28px;">
        <h3 style="color:var(--white)">–í—ñ–¥–≥—É–∫–∏{% if average_rating %} ‚Äî —Å–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–π—Ç–∏–Ω–≥: {{ average_rating }}{% endif %}</h3>

        {% if user.is_authenticated %}
          <form id="reviewForm" method="post" style="margin-top:12px;">
            {% csrf_token %}
            <label style="color:var(--muted)">–†–µ–π—Ç–∏–Ω–≥:
              <select name="rating" id="reviewRating">
                <option value="5">5</option>
                <option value="4">4</option>
                <option value="3">3</option>
                <option value="2">2</option>
                <option value="1">1</option>
              </select>
            </label>
            <div style="margin-top:8px;">
              <textarea name="comment" id="reviewComment" rows="3" style="width:100%;background:rgba(255,255,255,0.03);color:var(--white);border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:6px;" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å —Å–≤—ñ–π –≤—ñ–¥–≥—É–∫ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)"></textarea>
            </div>
            <div style="margin-top:8px;">
              <button id="submitReviewBtn" class="btn-action" type="button">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—ñ–¥–≥—É–∫</button>
            </div>
            <div id="reviewMsg" style="margin-top:8px;color:var(--muted)"></div>
          </form>
        {% else %}
          <p style="color:var(--muted)">–©–æ–± –∑–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫, –±—É–¥—å-–ª–∞—Å–∫–∞ <a href="{% url 'login' %}?next={{ request.path }}">—É–≤—ñ–π–¥—ñ—Ç—å</a>.</p>
        {% endif %}

        <div id="reviewsList" style="margin-top:18px;">
          {% if reviews %}
            {% for r in reviews %}
              <div class="review-card">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                  <div style="font-weight:800;color:var(--white)">{{ r.user.username }}</div>
                  <div style="color:var(--muted)">{{ r.created_at|date:"SHORT_DATETIME_FORMAT" }}</div>
                </div>
                <div style="margin-top:6px;">–†–µ–π—Ç–∏–Ω–≥: {{ r.rating }} / 5</div>
                {% if r.comment %}
                  <div style="margin-top:8px;color:var(--muted)">{{ r.comment }}</div>
                {% endif %}
              </div>
            {% endfor %}
          {% else %}
            <p style="color:var(--muted)">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –≤—ñ–¥–≥—É–∫—ñ–≤ ‚Äî –±—É–¥—å—Ç–µ –ø–µ—Ä—à–∏–º.</p>
          {% endif %}
        </div>
      </section>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  // CSRF helper
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // Quantity controls
  const qtyInput = document.getElementById('qty');
  document.getElementById('qty-incr').addEventListener('click', () => qtyInput.value = Math.max(1, parseInt(qtyInput.value||1) + 1));
  document.getElementById('qty-decr').addEventListener('click', () => qtyInput.value = Math.max(1, parseInt(qtyInput.value||1) - 1));

  // Thumbnail click -> change main image
  document.querySelectorAll('.thumb').forEach(t => t.addEventListener('click', () => {
    const img = t.querySelector('img');
    if (img) document.getElementById('mainImage').src = img.src;
  }));

  // Add to cart (AJAX)
  const addBtn = document.getElementById('addToCart');
  if (addBtn){
    addBtn.addEventListener('click', async function(){
      const btn = this;
      const pid = btn.dataset.productId;
      const qty = Math.max(1, parseInt(qtyInput.value || 1));
      const data = new FormData();
      data.append('product_id', pid);
      data.append('name', '{{ product.name|escapejs }}');
      data.append('price', Math.round(parseFloat('{{ product.price_per_100g }}' || '0')));
      data.append('currency', 'UAH');
      data.append('quantity', qty);

      // safe image url (use placeholder when missing)
      {% if product.image and product.image.url %}
      data.append('image', '{{ product.image.url }}');
      {% else %}
      data.append('image', '{% static "images/png/placeholder.png" %}');
      {% endif %}

      btn.disabled = true; btn.textContent = '–î–æ–¥–∞—é...';
      try {
        const res = await fetch("{% url 'add_to_cart' %}", { method: 'POST', headers: { 'X-CSRFToken': csrftoken }, body: data });
        const json = await res.json();
        if (!res.ok && json && json.login_url) {
          window.location.href = json.login_url + '&next=' + encodeURIComponent(window.location.pathname);
          return;
        }
        if (json.ok) {
          document.getElementById('product-msg').textContent = '–î–æ–¥–∞–Ω–æ –≤ –∫–æ—à–∏–∫';
          document.querySelectorAll('#cart-count').forEach(el => el.textContent = json.cart_count);
        } else {
          document.getElementById('product-msg').textContent = json.error || '–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è';
        }
      } catch (err) {
        console.error('Add to cart error', err);
        document.getElementById('product-msg').textContent = '–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ';
      } finally {
        btn.disabled = false; btn.textContent = '–î–æ –∫–æ—à–∏–∫–∞';
      }
    });
  }

  // Favorite toggle
  const favBtn = document.getElementById('favBtn');
  const favIcon = document.getElementById('favIcon');
  if (favBtn) {
    favBtn.addEventListener('click', async function(){
      const pid = this.dataset.productId;
      const data = new FormData(); data.append('product_id', pid);
      const wasFavorited = favBtn.classList.contains('favorited');
      try {
        const res = await fetch("{% url 'toggle_favorite' %}", { method: 'POST', headers: { 'X-CSRFToken': csrftoken }, body: data });
        const json = await res.json();
        if (!res.ok && json && json.login_url) { window.location.href = json.login_url + '&next=' + encodeURIComponent(window.location.pathname); return; }
        if (json.ok) {
          if (json.favorited) { favBtn.classList.add('favorited'); favIcon.textContent = '‚ù§Ô∏è'; }
          else { favBtn.classList.remove('favorited'); favIcon.textContent = 'ü§ç'; }
        } else {
          alert(json.error || '–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–∞–Ω–æ–≥–æ');
          if (wasFavorited) { favBtn.classList.add('favorited'); favIcon.textContent='‚ù§Ô∏è'; } else { favBtn.classList.remove('favorited'); favIcon.textContent='ü§ç'; }
        }
      } catch (err) {
        console.error('Favorite toggle error', err);
        alert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ');
      }
    });
  }

  // Submit review (AJAX) - robust handling and messages
  const submitBtn = document.getElementById('submitReviewBtn');
  if (submitBtn){
    submitBtn.addEventListener('click', async function(){
      const ratingEl = document.getElementById('reviewRating');
      const commentEl = document.getElementById('reviewComment');
      const reviewMsgEl = document.getElementById('reviewMsg');
      const rating = ratingEl ? ratingEl.value : '5';
      const comment = commentEl ? commentEl.value : '';

      submitBtn.disabled = true;
      submitBtn.textContent = '–ù–∞–¥—Å–∏–ª–∞—é...';
      reviewMsgEl.textContent = '';
      reviewMsgEl.style.color = '';

      try {
        const url = "{% url 'submit_review' product.id %}";
        const res = await fetch(url, {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken},
          body: new URLSearchParams({rating: rating, comment: comment})
        });

        const ct = res.headers.get('content-type') || '';
        let data;
        if (ct.indexOf('application/json') !== -1) {
          data = await res.json();
        } else {
          const text = await res.text();
          throw new Error('Unexpected response from server: ' + res.status + ' ‚Äî ' + text);
        }

        if (!res.ok) {
          if (data && data.login_url) {
            window.location.href = data.login_url + '&next=' + encodeURIComponent(window.location.pathname);
            return;
          }
          reviewMsgEl.textContent = data.error || ('–ü–æ–º–∏–ª–∫–∞: ' + res.status);
          reviewMsgEl.style.color = '#ff8a8a';
          submitBtn.disabled = false;
          submitBtn.textContent = '–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—ñ–¥–≥—É–∫';
          return;
        }

        reviewMsgEl.style.color = 'lightgreen';
        reviewMsgEl.textContent = data.message || '–î—è–∫—É—î–º–æ –∑–∞ –≤—ñ–¥–≥—É–∫.';
        setTimeout(()=> location.reload(), 800);

      } catch (err) {
        console.error('Review submission error:', err);
        reviewMsgEl.style.color = '#ff8080';
        reviewMsgEl.textContent = '–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ –∞–±–æ —Å–µ—Ä–≤–µ—Ä–∞ ‚Äî —Å–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—ñ–¥–≥—É–∫';
      }
    });
  }
})();
</script>
{% endblock %}