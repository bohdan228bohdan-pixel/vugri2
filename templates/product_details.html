{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} ‚Äî VugriUkraine{% endblock %}

{% block head_extra %}
<style>
/* Scoped product detail styles - responsive, polished, keeps existing look */

/* Tokens */
:root{ --muted:#9aa0a6; --white:#ffffff; --accent:#e75b2e; --thumb-size:56px; --radius:12px; }
#product-detail{ padding:28px 0; color:var(--white); }
#product-detail .inner{ max-width:1100px; margin:0 auto; padding:0 20px; box-sizing:border-box; }

/* layout */
.layout{ display:grid; grid-template-columns:1fr 420px; gap:28px; align-items:start; }
@media (max-width:980px){ .layout{ grid-template-columns:1fr; } }

/* gallery */
.gallery-main{ border-radius:var(--radius); overflow:hidden; background:#080808; min-height:320px; position:relative; }
.gallery-main img, .gallery-main iframe, .gallery-main video{ width:100%; height:420px; object-fit:cover; display:block; border:0; }
@media (max-width:900px){ .gallery-main img, .gallery-main iframe, .gallery-main video{ height:320px; } }
.thumbs{ display:flex; gap:10px; padding-top:8px; overflow:auto; -webkit-overflow-scrolling:touch; }
.thumb{ width:var(--thumb-size); height:var(--thumb-size); border-radius:8px; overflow:hidden; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; background:rgba(255,255,255,0.02); border:2px solid transparent; }
.thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
.thumb.active{ transform:translateY(-3px); border-color:rgba(255,255,255,0.07); }

/* info */
.info-col{ min-width:280px; max-width:640px; }
.price{ font-size:28px; font-weight:900; margin:18px 0; color:var(--white); }
.controls-row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:12px; }
.qty-input{ width:90px; text-align:center; padding:6px; border-radius:6px; background:rgba(255,255,255,0.03); color:var(--white); border:1px solid rgba(255,255,255,0.04); }

/* buttons */
.btn-add{ padding:10px 18px; border-radius:8px; font-weight:800; background:linear-gradient(90deg,var(--accent), #cc4a20); color:#fff; border:0; cursor:pointer; }
.btn-outline{ padding:8px 12px; border-radius:8px; background:transparent; color:var(--white); border:1px solid rgba(255,255,255,0.06); cursor:pointer; }
.btn-fav{ width:44px; height:44px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); color: var(--white); font-size:18px; cursor:pointer; }
.btn-fav.favorited{ background:linear-gradient(90deg,#ff4b6b,#ff2b2b); color:#fff; border-color: rgba(255,255,255,0.03); }

/* reviews & modal */
.review-card{ background: rgba(255,255,255,0.02); border-radius:10px; padding:12px; margin-bottom:10px; color:var(--muted); }
.callback-modal{ position:fixed; inset:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; padding:20px; z-index:2000; }
.callback-modal-inner{ background:#fff; color:#111; padding:18px; border-radius:8px; width:100%; max-width:540px; box-shadow:0 10px 40px rgba(0,0,0,0.4); }
</style>
{% endblock %}


<!-- ---------- product_details: HTML (–≤—Å—Ç–∞–≤–∏—Ç–∏ –≤ {% block content %}) ---------- -->
<div id="product-detail">
  <div class="inner">
    <div class="layout" role="main" aria-labelledby="product-title">

      <!-- LEFT: gallery -->
      <div class="img-col">
        <div class="gallery-main" id="galleryMain" tabindex="0" aria-live="polite">
          {% if images and images.0.url %}
            {% if images.0.is_video %}
              <iframe class="product-iframe" src="{{ images.0.url }}" frameborder="0" allowfullscreen title="–í—ñ–¥–µ–æ {{ product.name }}"></iframe>
            {% else %}
              <img id="mainImage" src="{{ images.0.url }}" alt="{{ product.name }}" loading="lazy"
                   onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
            {% endif %}
          {% elif product.image and product.image.url %}
            <img id="mainImage" src="{{ product.image.url }}" alt="{{ product.name }}" loading="lazy"
                 onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
          {% else %}
            <img id="mainImage" src="{% static 'images/png/placeholder.png' %}" alt="{{ product.name }}" loading="lazy">
          {% endif %}
        </div>

        <div class="thumbs" id="thumbs" role="tablist" aria-label="–ú—ñ–Ω—ñ–∞—Ç—é—Ä–∏">
          {% if images %}
            {% for im in images %}
              {% if im.url %}
                <div class="thumb{% if forloop.first %} active{% endif %}"
                     data-type="{% if im.is_video %}video{% else %}image{% endif %}"
                     data-img-url="{{ im.url }}"
                     data-video-url="{{ im.url }}"
                     role="tab"
                     aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
                  <img src="{{ im.thumb_url|default:im.url }}" alt="{{ im.alt|default:product.name }}">
                </div>
              {% endif %}
            {% endfor %}
          {% else %}
            {% if product.image and product.image.url %}
              <div class="thumb active" data-type="image" data-img-url="{{ product.image.url }}"><img src="{{ product.image.url }}" alt="{{ product.name }}"></div>
            {% else %}
              <div class="thumb active" data-type="image" data-img-url="{% static 'images/png/placeholder.png' %}"><img src="{% static 'images/png/placeholder.png' %}" alt="placeholder"></div>
            {% endif %}
          {% endif %}
        </div>
      </div>

      <!-- RIGHT: info & controls -->
      <div class="info-col" aria-labelledby="product-title">
        <h1 id="product-title">{{ product.name }}</h1>
        <div class="product-meta" style="color:var(--muted)">{{ product.description }}</div>

        <div class="price">
          {% if product.sold_in_units %}
            {% if product.price_per_unit %}
              <strong>{{ product.price_per_unit|floatformat:2 }} –≥—Ä–Ω / {{ product.unit_label|default:"—à—Ç" }}</strong>
            {% else %} <span>–¶—ñ–Ω–∞ —É—Ç–æ—á–Ω—é—î—Ç—å—Å—è</span> {% endif %}
          {% elif package_price %}
            {% if package_size %}
              <strong>{{ package_price }} –≥—Ä–Ω / {{ package_size }} –≥</strong>
            {% else %}
              <strong>{{ package_price }} –≥—Ä–Ω</strong>
            {% endif %}
          {% else %}
            {% if product.price_per_100g %}
              <strong>{{ product.price_per_100g|floatformat:2 }} –≥—Ä–Ω / 100–≥</strong>
            {% else %} <span>–¶—ñ–Ω–∞ —É—Ç–æ—á–Ω—é—î—Ç—å—Å—è</span> {% endif %}
          {% endif %}
        </div>

        <div class="controls-row" role="group" aria-label="–î—ñ—ó –∑ —Ç–æ–≤–∞—Ä–æ–º">
          <div style="display:flex;align-items:center;gap:8px">
            <button id="qty-decr" class="btn-outline" type="button" aria-label="–∑–º–µ–Ω—à–∏—Ç–∏">‚àí</button>
            <input id="qty" class="qty-input" type="number" value="1" min="1" step="1" aria-label="–∫—ñ–ª—å–∫—ñ—Å—Ç—å" />
            <button id="qty-incr" class="btn-outline" type="button" aria-label="–∑–±—ñ–ª—å—à–∏—Ç–∏">+</button>

            <button id="requestCallbackBtn" class="btn-outline" data-product-id="{{ product.id }}" data-product-name="{{ product.name }}">
              –ó–∞–º–æ–≤–∏—Ç–∏ –∑–≤–æ—Ä–æ—Ç–Ω—ñ–π –∑–≤'—è–∑–æ–∫
            </button>
          </div>

          <div style="display:flex;gap:10px;align-items:center">
            {% if user.is_authenticated %}
              <button id="addToCart" class="btn-add" data-product-id="{{ product.id }}" {% if not product.in_stock %}disabled title="–¢–æ–≤–∞—Ä —Ç–∏–º—á–∞—Å–æ–≤–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π"{% endif %}>
                {% if product.in_stock %}–î–æ –∫–æ—à–∏–∫–∞{% else %}–ù–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ{% endif %}
              </button>
            {% else %}
              <a href="{% url 'login' %}?next={{ request.path }}" class="btn-add">–£–≤—ñ–π—Ç–∏, —â–æ–± –∫—É–ø–∏—Ç–∏</a>
            {% endif %}

            <button id="favBtn" class="btn-fav {% if is_favorited %}favorited{% endif %}" data-product-id="{{ product.id }}" aria-pressed="{% if is_favorited %}true{% else %}false{% endif %}" title="–î–æ–¥–∞—Ç–∏ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ">
              <span id="favIcon">{% if is_favorited %}‚ù§Ô∏è{% else %}ü§ç{% endif %}</span>
            </button>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:12px;align-items:center">
          {% if product.in_stock %}
            <span id="stockBadge" class="stock-badge stock-yes">–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</span>
          {% else %}
            <span id="stockBadge" class="stock-badge stock-no">–ù–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</span>
          {% endif %}
          {% if user.is_staff %}
            <button id="toggleStockBtn" data-product-id="{{ product.id }}" class="btn-outline" style="margin-left:12px;">{% if product.in_stock %}–ü–æ—Å—Ç–∞–≤–∏—Ç–∏ —è–∫ ¬´–Ω–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ¬ª{% else %}–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –≤ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å{% endif %}</button>
          {% endif %}
        </div>

        <hr style="border-color:rgba(255,255,255,0.04); margin-top:16px">

        <h4 style="color:var(--white)">–û–ø–∏—Å</h4>
        <p style="color:var(--muted)">{{ product.description }}</p>
      </div>
    </div>

    <!-- REVIEWS -->
    <section id="reviews" style="margin-top:28px;">
      <h3 id="reviews-heading">–í—ñ–¥–≥—É–∫–∏{% if average_rating %} ‚Äî —Å–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–π—Ç–∏–Ω–≥: {{ average_rating }}{% endif %}</h3>

      {% if user.is_authenticated %}
        <form id="reviewForm" method="post" onsubmit="return false;">
          {% csrf_token %}
          <label style="color:var(--muted)">–†–µ–π—Ç–∏–Ω–≥:
            <select name="rating" id="reviewRating">
              <option value="5">5</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option>
            </select>
          </label>
          <div style="margin-top:8px;">
            <textarea name="comment" id="reviewComment" rows="3" style="width:100%;background:rgba(255,255,255,0.03);color:var(--white);border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:6px;" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å —Å–≤—ñ–π –≤—ñ–¥–≥—É–∫ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)"></textarea>
          </div>
          <div style="margin-top:8px;">
            <button id="submitReviewBtn" class="btn-outline" type="button">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—ñ–¥–≥—É–∫</button>
          </div>
          <div id="reviewMsg" style="margin-top:8px;color:var(--muted)"></div>
        </form>
      {% else %}
        <p style="color:var(--muted)">–©–æ–± –∑–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫, –±—É–¥—å-–ª–∞—Å–∫–∞ <a href="{% url 'login' %}?next={{ request.path }}">—É–≤—ñ–π–¥—ñ—Ç—å</a>.</p>
      {% endif %}

      <div id="reviewsList" style="margin-top:12px;">
        {% if reviews %}
          {% for r in reviews %}
            <div id="review-{{ r.id }}" class="review-card" role="article">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <div style="font-weight:700;color:var(--white)">{{ r.user.username }}</div>
                  <div style="color:var(--muted);font-size:0.85rem">{{ r.created_at|date:"SHORT_DATETIME_FORMAT" }}</div>
                </div>
                {% if user.is_authenticated and user.username == 'VugriUa' %}
                  <button type="button" class="delete-review-btn btn-outline" data-review-id="{{ r.id }}" data-delete-url="{% url 'delete_review' r.id %}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                {% endif %}
              </div>
              {% if r.comment %}<div style="margin-top:8px;color:var(--muted)">{{ r.comment }}</div>{% endif %}
            </div>
          {% endfor %}
        {% else %}
          <p style="color:var(--muted)">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –≤—ñ–¥–≥—É–∫—ñ–≤ ‚Äî –±—É–¥—å—Ç–µ –ø–µ—Ä—à–∏–º.</p>
        {% endif %}
      </div>
    </section>
  </div>
</div>

<!-- CALLBACK modal -->
<div id="callbackModal" class="callback-modal" style="display:none;">
  <div class="callback-modal-inner" role="dialog" aria-modal="true" aria-labelledby="cbTitle">
    <h3 id="cbTitle">–ó–∞–º–æ–≤–∏—Ç–∏ –∑–≤–æ—Ä–æ—Ç–Ω—ñ–π –∑–≤'—è–∑–æ–∫</h3>
    <form id="callbackForm" method="post">
      {% csrf_token %}
      <input type="hidden" name="product" id="cb_product" value="{{ product.id }}">
      <div><label>–¢–µ–ª–µ—Ñ–æ–Ω *</label><input type="text" name="phone" id="cb_phone" placeholder="+380XXXXXXXXX" required></div>
      <div style="margin-top:8px;"><label>–Ü–º'—è</label><input type="text" name="name" id="cb_name"></div>
      <div style="margin-top:10px;"><button type="submit" id="cbSendBtn" class="btn btn-primary">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button> <button type="button" id="cbCancel" class="btn-outline">–°–∫–∞—Å—É–≤–∞—Ç–∏</button></div>
      <div id="cbResult" style="margin-top:10px;display:none;"></div>
    </form>
  </div>
</div>
{% endblock %}


<!-- ---------- product_details: scripts (–≤—Å—Ç–∞–≤–∏—Ç–∏ –≤ {% block scripts %}) ---------- -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  // helpers
  const q = (sel, ctx=document) => ctx.querySelector(sel);
  const qa = (sel, ctx=document) => Array.from((ctx||document).querySelectorAll(sel));
  const getCookie = (name) => { const v = document.cookie.split('; ').find(c=>c.trim().startsWith(name+'=')); return v ? decodeURIComponent(v.split('=')[1]) : null; };
  const csrftoken = getCookie('csrftoken');

  // gallery
  const mediaContainer = q('#galleryMain');
  const thumbs = qa('.thumb');
  const showImage = (src, alt='') => {
    if(!mediaContainer) return;
    mediaContainer.innerHTML = '';
    const img = document.createElement('img');
    img.className='product-img';
    img.src = src;
    img.alt = alt;
    img.loading = 'lazy';
    img.onerror = function(){ this.onerror=null; this.src = '{% static "images/png/placeholder.png" %}'; };
    mediaContainer.appendChild(img);
  };

  thumbs.forEach(t => {
    t.addEventListener('click', function(e){
      e.preventDefault();
      thumbs.forEach(x=>x.classList.remove('active'));
      this.classList.add('active');
      const type = (this.dataset.type||'image').toLowerCase();
      const imgUrl = this.dataset.imgUrl || this.getAttribute('data-img-url');
      const videoUrl = this.dataset.videoUrl || this.getAttribute('data-video-url');
      if(type==='video'){ const url = videoUrl || imgUrl; if(url) window.open(url,'_blank'); }
      else if(imgUrl){ showImage(imgUrl); }
    });
    t.addEventListener('keydown', (e) => { if(e.key==='Enter' || e.key===' ') { e.preventDefault(); t.click(); } });
  });

  // qty controls
  const qty = q('#qty'), inc = q('#qty-incr'), dec = q('#qty-decr');
  if(inc && dec && qty){ inc.addEventListener('click', ()=> qty.value = Math.max(1, parseInt(qty.value||1) + 1)); dec.addEventListener('click', ()=> qty.value = Math.max(1, parseInt(qty.value||1) - 1)); }

  // add to cart
  const addBtn = q('#addToCart');
  if(addBtn){
    addBtn.addEventListener('click', async function(){
      const pid = this.dataset.productId;
      const quantity = Math.max(1, parseInt(q('#qty')?.value||1));
      const data = new URLSearchParams({ product_id: pid, quantity });
      try {
        const res = await fetch("{% url 'add_to_cart' %}", { method: 'POST', headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest' }, body: data, credentials: 'same-origin' });
        const json = await res.json().catch(()=>null);
        if(res.ok && json && json.ok){ alert('–î–æ–¥–∞–Ω–æ –≤ –∫–æ—à–∏–∫'); if(json.cart_count) qa('#cart-count').forEach(el=>el.textContent=json.cart_count); }
        else if(json && json.login_url){ window.location = json.login_url + '&next=' + encodeURIComponent(window.location.pathname); }
        else alert(json?.error || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ –≤ –∫–æ—à–∏–∫');
      } catch(e){ console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ'); }
    });
  }

  // toggle favorite
  const favBtn = q('#favBtn'), favIcon = q('#favIcon');
  if(favBtn){
    favBtn.addEventListener('click', async function(){
      const pid = this.dataset.productId;
      try {
        const res = await fetch("{% url 'toggle_favorite' %}", { method:'POST', headers:{ 'X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest' }, body: new URLSearchParams({product_id: pid}), credentials:'same-origin' });
        const json = await res.json().catch(()=>null);
        if(res.ok && json && json.ok){
          if(json.favorited){ favBtn.classList.add('favorited'); if(favIcon) favIcon.textContent='‚ù§Ô∏è'; favBtn.setAttribute('aria-pressed','true'); }
          else { favBtn.classList.remove('favorited'); if(favIcon) favIcon.textContent='ü§ç'; favBtn.setAttribute('aria-pressed','false'); }
        } else if(json && json.login_url) { window.location = json.login_url + '&next=' + encodeURIComponent(window.location.pathname); }
      } catch(e){ console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ'); }
    });
  }

  // submit review
  const submitBtn = q('#submitReviewBtn'), reviewMsgEl = q('#reviewMsg');
  if(submitBtn){
    submitBtn.addEventListener('click', async function(){
      const rating = q('#reviewRating')?.value || '5';
      const comment = q('#reviewComment')?.value || '';
      try {
        const res = await fetch("{% url 'submit_review' product.id %}", { method:'POST', headers:{ 'X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest' }, body: new URLSearchParams({ rating, comment }), credentials:'same-origin' });
        const json = await res.json().catch(()=>null);
        if(res.ok && json && json.ok){ reviewMsgEl.style.color='lightgreen'; reviewMsgEl.textContent = json.message || '–î—è–∫—É—î–º–æ'; setTimeout(()=>location.reload(),700); }
        else if(json && json.login_url){ window.location = json.login_url + '&next=' + encodeURIComponent(window.location.pathname); }
        else { reviewMsgEl.style.color='#ff8a8a'; reviewMsgEl.textContent = json?.error || '–ü–æ–º–∏–ª–∫–∞'; }
      } catch(e){ console.error(e); reviewMsgEl.style.color='#ff8080'; reviewMsgEl.textContent='–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ'; }
    });
  }

  // toggle availability (admin)
  const toggleBtn = q('#toggleStockBtn'), stockBadge = q('#stockBadge');
  if(toggleBtn){
    toggleBtn.addEventListener('click', async function(){
      if(!confirm('–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–º—ñ–Ω—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ —Ç–æ–≤–∞—Ä—É?')) return;
      const pid = this.dataset.productId;
      const base = "{% url 'toggle_availability' 0 %}";
      const url = base.replace('/0/', '/' + pid + '/');
      try {
        const res = await fetch(url, { method:'POST', headers:{ 'X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest' }, credentials:'same-origin' });
        const json = await res.json().catch(()=>null);
        if(res.ok && json && json.ok){
          if(json.in_stock){ if(stockBadge){ stockBadge.textContent='–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ'; stockBadge.classList.remove('stock-no'); stockBadge.classList.add('stock-yes'); } toggleBtn.textContent='–ü–æ—Å—Ç–∞–≤–∏—Ç–∏ —è–∫ ¬´–Ω–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ¬ª'; }
          else { if(stockBadge){ stockBadge.textContent='–ù–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ'; stockBadge.classList.remove('stock-yes'); stockBadge.classList.add('stock-no'); } toggleBtn.textContent='–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –≤ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å'; }
        } else alert(json?.error || '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å');
      } catch(e){ console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ –∞–±–æ –¥–æ—Å—Ç—É–ø—É'); }
    });
  }

  // delete review (admin)
  qa('.delete-review-btn').forEach(btn => {
    btn.addEventListener('click', async function(e){
      e.preventDefault();
      if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –≤—ñ–¥–≥—É–∫?')) return;
      const url = this.dataset.deleteUrl;
      try {
        const res = await fetch(url, { method:'POST', headers:{ 'X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest' }, credentials:'same-origin' });
        const json = await res.json().catch(()=>null);
        if(res.ok && json && json.ok){ const el = q('#review-'+this.dataset.reviewId); if(el) el.remove(); }
        else alert(json?.error || '–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—ñ–¥–≥—É–∫');
      } catch(e){ console.error(e); alert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ'); }
    });
  });

  // callback modal handlers
  const openBtn = q('#requestCallbackBtn'), modal = q('#callbackModal'), cbForm = q('#callbackForm'), cbCancel = q('#cbCancel'), cbResult = q('#cbResult');
  function openModal(productId){ if(cbForm) cbForm.querySelector('#cb_product').value = productId || ''; if(modal) modal.style.display='flex'; if(cbResult) cbResult.style.display='none'; }
  function closeModal(){ if(modal) modal.style.display='none'; }
  if(openBtn) openBtn.addEventListener('click', e=>{ e.preventDefault(); openModal(openBtn.dataset.productId || '{{ product.id }}'); });
  if(cbCancel) cbCancel.addEventListener('click', e=>{ e.preventDefault(); closeModal(); });
  if(cbForm){
    cbForm.addEventListener('submit', async function(e){
      e.preventDefault();
      const data = new FormData(cbForm);
      try {
        const res = await fetch("{% url 'request_callback' %}", { method:'POST', headers:{ 'X-CSRFToken': getCookie('csrftoken') }, body: data, credentials:'same-origin' });
        const json = await res.json().catch(()=>null);
        if(res.ok && json && json.ok){ if(cbResult){ cbResult.style.color='green'; cbResult.textContent = json.message || '–î—è–∫—É—î–º–æ'; cbResult.style.display='block'; } cbForm.reset(); setTimeout(closeModal,1400); }
        else { if(cbResult){ cbResult.style.color='red'; cbResult.textContent = json?.error || '–ü–æ–º–∏–ª–∫–∞'; cbResult.style.display='block'; } }
      } catch(err){ console.error(err); if(cbResult){ cbResult.style.color='red'; cbResult.textContent='–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ'; cbResult.style.display='block'; } }
    });
  }
});
</script>
{% endblock %}
