{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} ‚Äî VugriUkraine{% endblock %}

{% block head_extra %}
<style>
/* Product detail scoped styles (kept compact) */
#product-detail { padding: 28px 0; color: var(--white); }
#product-detail .inner { max-width: 1100px; margin: 0 auto; padding: 0 24px; }
#product-detail .layout { display:flex; gap:28px; flex-wrap:wrap; align-items:flex-start; justify-content:center; }

/* Image column */
#product-detail .img-col { flex:1; max-width:560px; min-width:260px; }
#product-detail .product-img-wrap { width:100%; height:420px; overflow:hidden; border-radius:12px; background:#0b0b0b; }
#product-detail .product-img, #product-detail .product-iframe { width:100%; height:100%; object-fit:cover; display:block; border:0; }

/* Thumbnails */
#product-detail .thumbs { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
#product-detail .thumb { width:56px; height:56px; border-radius:6px; overflow:hidden; cursor:pointer; border:2px solid transparent; background:#111; display:inline-block; position:relative; }
#product-detail .thumb img { width:100%; height:100%; object-fit:cover; display:block; }
#product-detail .thumb.active { border-color:#2a9d8f; box-shadow:0 6px 18px rgba(0,0,0,0.35); }
#product-detail .thumb-thumb-video .play-icon, .thumb-video .play-icon { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); color:#fff; font-weight:800; pointer-events:none; font-size:14px; }

/* Info column */
#product-detail .info-col { flex:1; min-width:280px; max-width:640px; }
#product-detail h1 { margin:0 0 8px; font-weight:900; color:var(--white); }
#product-detail .product-meta { color:var(--muted); margin-bottom:12px; }

/* Price */
#product-detail .price { font-size:28px; font-weight:900; color:var(--white); margin:18px 0; }

/* Controls */
#product-detail .controls-row { display:flex; align-items:center; gap:12px; margin-top:12px; flex-wrap:wrap; }
#product-detail .qty-input { width:90px; text-align:center; background:rgba(255,255,255,0.03); color:var(--white); border:1px solid rgba(255,255,255,0.04); padding:6px; border-radius:6px; }
#product-detail .btn-add { background:var(--accent); color:#fff; border:none; padding:10px 18px; border-radius:8px; font-weight:800; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; }
#product-detail .btn-fav { display:inline-flex; align-items:center; justify-content:center; width:44px; height:44px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); color: var(--white); font-size:18px; cursor:pointer; }
#product-detail .btn-fav.favorited { background: linear-gradient(90deg,#ff4b6b,#ff2b2b); color:#fff; border-color: rgba(255,255,255,0.03); }

/* Stock badge & admin toggle */
.stock-badge { padding:6px 10px; border-radius:8px; font-weight:700; color:#fff; }
.stock-yes { background: #1db954; }
.stock-no { background: #d9534f; }
.toggle-stock-btn { padding:8px 12px; border-radius:8px; background:#111; color:var(--accent); border:1px solid rgba(255,255,255,0.04); cursor:pointer; }

/* Messages */
#product-detail #product-msg { margin-top:12px; color:var(--muted); }

/* Responsive */
@media (max-width: 900px) {
  #product-detail .product-img-wrap { height:320px; }
  #product-detail .layout { gap:18px; }
}
</style>
{% endblock %}

{% block content %}
<div id="product-detail" class="{% if not product.in_stock %}product-out-of-stock{% endif %}">
  <div class="inner">
    <div class="layout" role="main" aria-labelledby="product-title">
      <!-- Left: images -->
      <div class="img-col">
        {# –∑–∞–º—ñ–Ω–∏—Ç–∏ —ñ—Å–Ω—É—é—á–∏–π –±–ª–æ–∫ product-img-wrap + thumbs –Ω–∞ —Ü–µ #}
<div class="product-img-wrap" aria-hidden="false">
  <div id="mediaContainer">
    {% if product.id == 1 %}
      <img id="mainImage" src="{% static 'images/–≤—É–≥–æ—Ä 1.jpg' %}" alt="{{ product.name }}" class="product-img"
           onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
    {% elif product.id == 2 %}
      <img id="mainImage" src="{% static 'images/–∫–∞—Ä–∞—Å—å –ø–µ—á–µ–Ω–∏–π 1.jpg' %}" alt="{{ product.name }}" class="product-img"
           onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
    {% elif product.id == 3 %}
      <img id="mainImage" src="{% static 'images/—Ü—ñ–ª–∞ —Å—Ç–µ–π–∫ —Ñ—ñ–ª–µ 1.jpg' %}" alt="{{ product.name }}" class="product-img"
           onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
    {% elif product.id == 4 %}
      <img id="mainImage" src="{% static 'images/—ñ–∫—Ä–∞ –∫–µ—Ç–∏ 1.jpg' %}" alt="{{ product.name }}" class="product-img"
           onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
    {% elif product.id == 5 %}
      <img id="mainImage" src="{% static 'images/—ñ–∫—Ä–∞ –∫–µ—Ç–∏ –ø—Ä–µ–º—ñ—É–º 1.jpg' %}" alt="{{ product.name }}" class="product-img"
           onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
    {% elif product.id == 6 %}
      <img id="mainImage" src="{% static 'images/—ñ–∫—Ä–∞ —Ñ–æ—Ä–µ–ª—ñ –ø–∞—Å—Ç–µ—Ä–∏–∑–æ–≤–∞–Ω–∞.jpg' %}" alt="{{ product.name }}" class="product-img"
           onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
    {% elif product.id == 7 %}
      <img id="mainImage" src="{% static 'images/—ñ–∫—Ä–∞ —á–æ—Ä–Ω–∞ 1.jpg' %}" alt="{{ product.name }}" class="product-img"
           onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
    {% elif product.id == 8 %}
      <img id="mainImage" src="{% static 'images/—ñ–∫—Ä–∞ —â—É–∫—ñ —Å–ª–∞–±–æ—Å–æ–ª–µ–Ω–∞ 1.jpg' %}" alt="{{ product.name }}" class="product-img"
           onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
    {% elif product.id == 9 %}
      <img id="mainImage" src="{% static 'images/–º–µ–¥–∞–ª—å–π–æ–Ω–∏ —ñ–∑ —à–º–∞—Ç–æ—á–∫—ñ–≤ —Ç—É–Ω—Ü—è.jpg' %}" alt="{{ product.name }}" class="product-img"
           onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
    {% elif product.id == 10 %}
      <img id="mainImage" src="{% static 'images/–º—è—Å–æ –∫—Ä–∞–±–∞ 1.jpg' %}" alt="{{ product.name }}" class="product-img"
           onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
    {% elif product.id == 11 %}
      <img id="mainImage" src="{% static 'images/–ø–µ—á—ñ–Ω–∫–∞ —Ç—Ä—ñ—Å–∫–∏ 1.jpg' %}" alt="{{ product.name }}" class="product-img"
           onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
    {% elif product.id == 12 %}
      <img id="mainImage" src="{% static 'images/—á–µ—Ä–≤–æ–Ω–∞ —ñ–∫—Ä–∞ –∫–µ—Ç–∞.jpg' %}" alt="{{ product.name }}" class="product-img"
           onerror="this.onerror=null;this.src='{% static 'images/png/placeholder.png' %}';">
    {% else %}
      <img id="mainImage" src="{% static 'images/png/placeholder.png' %}" alt="{{ product.name }}" class="product-img">
    {% endif %}
  </div>
</div>

<div class="thumbs" aria-hidden="false" id="thumbs">
  {# image thumbs (–ø—Ä–∏–∫–ª–∞–¥ –¥–ª—è id 1) #}
  {% if product.id == 1 %}
    <div class="thumb" data-type="image" data-img-url="{% static 'images/–≤—É–≥–æ—Ä 1.jpg' %}">
      <img src="{% static 'images/–≤—É–≥–æ—Ä 1.jpg' %}" alt="thumb">
    </div>
    <div class="thumb" data-type="image" data-img-url="{% static 'images/–≤—É–≥–æ—Ä 2.jpg' %}">
      <img src="{% static 'images/–≤—É–≥–æ—Ä 2.jpg' %}" alt="thumb2">
    </div>
    <div class="thumb" data-type="image" data-img-url="{% static 'images/–≤—É–≥–æ—Ä 3.jpg' %}">
      <img src="{% static 'images/–≤—É–≥–æ—Ä 3.jpg' %}" alt="thumb3">
    </div>
    <div class="thumb" data-type="image" data-img-url="{% static 'images/–≤—É–≥–æ—Ä 5.jpg' %}">
      <img src="{% static 'images/–≤—É–≥–æ—Ä 5.jpg' %}" alt="thumb5">
    </div>
    <div class="thumb" data-type="image" data-img-url="{% static 'images/–≤—É–≥–æ—Ä 4.jpg' %}">
      <img src="{% static 'images/–≤—É–≥–æ—Ä 4.jpg' %}" alt="thumb4">
    </div>
    {# video thumb: –±–µ—Ä–µ–º–æ URL –∑ –º–æ–¥–µ–ª—ñ (–∞–±–æ –≤—Å—Ç–∞–≤–ª—è—î–º–æ —Ä—è–¥–æ–∫) #}
    <div class="thumb thumb-video" data-type="video" data-video-url="{{ product.youtube_url }}">
      <img src="{% static 'images/thumbs/video_placeholder.png' %}" alt="video">
      <span class="play-icon">‚ñ∂</span>
    </div>

  {% elif product.id == 2 %}
    {# thumbs –¥–ª—è product.id == 2 #}
    <div class="thumb" data-type="image" data-img-url="{% static 'images/–∫–∞—Ä–∞—Å—å –ø–µ—á–µ–Ω–∏–π 1.jpg' %}">
      <img src="{% static 'images/–∫–∞—Ä–∞—Å—å –ø–µ—á–µ–Ω–∏–π 1.jpg' %}" alt="thumb">
    </div>
    <div class="thumb" data-type="image" data-img-url="{% static 'images/–∫–∞—Ä–∞—Å—å –ø–µ—á–µ–Ω–∏–π 2.jpg' %}">
      <img src="{% static 'images/–∫–∞—Ä–∞—Å—å –ø–µ—á–µ–Ω–∏–π 2.jpg' %}" alt="thumb">
    </div>

    {% elif product.id == 3 %}
    {# thumbs –¥–ª—è product.id == 3 #}
    <div class="thumb" data-type="image" data-img-url="{% static 'images/—Ü—ñ–ª–∞ —Å—Ç–µ–π–∫ —Ñ—ñ–ª–µ 1.jpg' %}">
      <img src="{% static 'images/—Ü—ñ–ª–∞ —Å—Ç–µ–π–∫ —Ñ—ñ–ª–µ 1.jpg' %}" alt="thumb">
    </div>
    <div class="thumb" data-type="image" data-img-url="{% static 'images/—Ü—ñ–ª–∞ —Å—Ç–µ–π —Ñ—ñ–ª–µ 2.jpg' %}">
      <img src="{% static 'images/—Ü—ñ–ª–∞ —Å—Ç–µ–π —Ñ—ñ–ª–µ 2.jpg' %}" alt="thumb">
    </div>

    {% elif product.id == 4 %}
    {# thumbs –¥–ª—è product.id == 4 #}
    <div class="thumb" data-type="image" data-img-url="{% static 'images/—ñ–∫—Ä–∞ –∫–µ—Ç–∏ 1.jpg' %}">
      <img src="{% static 'images/—ñ–∫—Ä–∞ –∫–µ—Ç–∏ 1.jpg' %}" alt="thumb">
    </div>
    <div class="thumb" data-type="image" data-img-url="{% static 'images/—ñ–∫—Ä–∞ –∫–µ—Ç–∏ 2.jpg' %}">
      <img src="{% static 'images/—ñ–∫—Ä–∞ –∫–µ—Ç–∏ 2.jpg' %}" alt="thumb">
    </div>
    <div class="thumb" data-type="image" data-img-url="{% static 'images/—ñ–∫—Ä–∞ –∫–µ—Ç–∏ 3.jpg' %}">
      <img src="{% static 'images/—ñ–∫—Ä–∞ –∫–µ—Ç–∏ 3.jpg' %}" alt="thumb">
    </div>
    <div class="thumb" data-type="image" data-img-url="{% static 'images/—ñ–∫—Ä–∞ –∫–µ—Ç–∏ 4.jpg' %}">
      <img src="{% static 'images/—ñ–∫—Ä–∞ –∫–µ—Ç–∏ 4.jpg' %}" alt="thumb">
    </div>

    {% elif product.id == 5 %}
    {# thumbs –¥–ª—è product.id == 5 #}
    <div class="thumb" data-type="image" data-img-url="{% static 'images/—ñ–∫—Ä–∞ –∫–µ—Ç–∏ –ø—Ä–µ–º—ñ—É–º 1.jpg' %}">
      <img src="{% static 'images/—ñ–∫—Ä–∞ –∫–µ—Ç–∏ –ø—Ä–µ–º—ñ—É–º 1.jpg' %}" alt="thumb">
    </div>
    <div class="thumb" data-type="image" data-img-url="{% static 'images/—ñ–∫—Ä–∞ –∫–µ—Ç–∏ –ø—Ä–µ–º—ñ—É–º 2.jpg' %}">
      <img src="{% static 'images/—ñ–∫—Ä–∞ –∫–µ—Ç–∏ –ø—Ä–µ–º—ñ—É–º 2.jpg' %}" alt="thumb">
    </div>

    {% elif product.id == 6 %}
    {# thumbs –¥–ª—è product.id == 6 #}
    <div class="thumb" data-type="image" data-img-url="{% static 'images/—ñ–∫—Ä–∞ —Ñ–æ—Ä–µ–ª—ñ –ø–∞—Å—Ç–µ—Ä–∏–∑–æ–≤–∞–Ω–∞.jpg' %}">
      <img src="{% static 'images/—ñ–∫—Ä–∞ —Ñ–æ—Ä–µ–ª—ñ –ø–∞—Å—Ç–µ—Ä–∏–∑–æ–≤–∞–Ω–∞.jpg' %}" alt="thumb">
    </div>

    {% elif product.id == 7 %}
    {# thumbs –¥–ª—è product.id == 7 #}
    <div class="thumb" data-type="image" data-img-url="{% static 'images/—ñ–∫—Ä–∞ —á–æ—Ä–Ω–∞ 1.jpg' %}">
      <img src="{% static 'images/—ñ–∫—Ä–∞ —á–æ—Ä–Ω–∞ 1.jpg' %}" alt="thumb">
    </div>
    <div class="thumb" data-type="image" data-img-url="{% static 'images/—ñ–∫—Ä–∞ —á–æ—Ä–Ω–∞ 2.jpg' %}">
      <img src="{% static 'images/—ñ–∫—Ä–∞ —á–æ—Ä–Ω–∞ 2.jpg' %}" alt="thumb">
    </div>

    {% elif product.id == 8 %}
    {# thumbs –¥–ª—è product.id == 8 #}
    <div class="thumb" data-type="image" data-img-url="{% static 'images/—ñ–∫—Ä–∞ —â—É–∫—ñ —Å–ª–∞–±–æ—Å–æ–ª–µ–Ω–∞ 1.jpg' %}">
      <img src="{% static 'images/—ñ–∫—Ä–∞ —â—É–∫—ñ —Å–ª–∞–±–æ—Å–æ–ª–µ–Ω–∞ 1.jpg' %}" alt="thumb">
    </div>
    <div class="thumb" data-type="image" data-img-url="{% static 'images/—ñ–∫—Ä–∞ —â—É–∫—ñ —Å–ª–∞–±–æ—Å–æ–ª–µ–Ω–∞ 2.jpg' %}">
      <img src="{% static 'images/—ñ–∫—Ä–∞ —â—É–∫—ñ —Å–ª–∞–±–æ—Å–æ–ª–µ–Ω–∞ 2.jpg' %}" alt="thumb">
    </div>
    <div class="thumb" data-type="image" data-img-url="{% static 'images/—ñ–∫—Ä–∞ —â—É–∫—ñ —Å–ª–∞–±–æ—Å–æ–ª–µ–Ω–∞ 3.jpg' %}">
      <img src="{% static 'images/—ñ–∫—Ä–∞ —â—É–∫—ñ —Å–ª–∞–±–æ—Å–æ–ª–µ–Ω–∞ 3.jpg' %}" alt="thumb">
    </div>
    <div class="thumb" data-type="image" data-img-url="{% static 'images/—ñ–∫—Ä–∞ —â—É–∫—ñ —Å–ª–∞–±–æ—Å–æ–ª–µ–Ω–∞ 4.jpg' %}">
      <img src="{% static 'images/—ñ–∫—Ä–∞ —â—É–∫—ñ —Å–ª–∞–±–æ—Å–æ–ª–µ–Ω–∞ 4.jpg' %}" alt="thumb">
    </div>

    {% elif product.id == 9 %}
    {# thumbs –¥–ª—è product.id == 9 # }
    <div class="thumb" data-type="image" data-img-url="{% static 'images/–º–µ–¥–∞–ª—å–π–æ–Ω–∏ —ñ–∑ —à–º–∞—Ç–æ—á–∫—ñ–≤ —Ç—É–Ω—Ü—è.jpg' %}">
      <img src="{% static 'images/–º–µ–¥–∞–ª—å–π–æ–Ω–∏ —ñ–∑ —à–º–∞—Ç–æ—á–∫—ñ–≤ —Ç—É–Ω—Ü—è.jpg' %}" alt="thumb">
    </div>

    {% elif product.id == 10 %}
    {# thumbs –¥–ª—è product.id == 10 #}
    <div class="thumb" data-type="image" data-img-url="{% static 'images/–º—è—Å–æ –∫—Ä–∞–±–∞ 1.jpg' %}">
      <img src="{% static 'images/–º—è—Å–æ –∫—Ä–∞–±–∞ 1.jpg' %}" alt="thumb">
    </div>
    <div class="thumb" data-type="image" data-img-url="{% static 'images/–º—è—Å–æ –∫—Ä–∞–±–∞ 2.jpg' %}">
      <img src="{% static 'images/–º—è—Å–æ –∫—Ä–∞–±–∞ 2.jpg' %}" alt="thumb">
    </div>

    {% elif product.id == 11 %}
    {# thumbs –¥–ª—è product.id == 11 #}
    <div class="thumb" data-type="image" data-img-url="{% static 'images/–ø–µ—á—ñ–Ω–∫–∞ —Ç—Ä—ñ—Å–∫–∏ 1.jpg' %}">
      <img src="{% static 'images/–ø–µ—á—ñ–Ω–∫–∞ —Ç—Ä—ñ—Å–∫–∏ 1.jpg' %}" alt="thumb">
    </div>
    <div class="thumb" data-type="image" data-img-url="{% static 'images/–ø–µ—á—ñ–Ω–∫–∞ —Ç—Ä—ñ—Å–∫–∏ 2.jpg' %}">
      <img src="{% static 'images/–ø–µ—á—ñ–Ω–∫–∞ —Ç—Ä—ñ—Å–∫–∏ 2.jpg' %}" alt="thumb">
    </div>

    {% elif product.id == 12 %}
    {# thumbs –¥–ª—è product.id == 12 #}
    <div class="thumb" data-type="image" data-img-url="{% static 'images/—á–µ—Ä–≤–æ–Ω–∞ —ñ–∫—Ä–∞ –∫–µ—Ç–∞.jpg' %}">
      <img src="{% static 'images/—á–µ—Ä–≤–æ–Ω–∞ —ñ–∫—Ä–∞ –∫–µ—Ç–∞.jpg' %}" alt="thumb">
    </div>
  {% else %}
    <div class="thumb" data-type="image" data-img-url="{% static 'images/png/placeholder.png' %}">
      <img src="{% static 'images/png/placeholder.png' %}" alt="placeholder">
    </div>
  {% endif %}
</div>

          {# Video thumb (only if a URL exists) #}
          {% if product.youtube_url %}
            <div class="thumb thumb-video" data-type="video" data-video-url="{{ product.youtube_url }}">
              <img src="{% static 'images/thumbs/video_placeholder.png' %}" alt="video">
              <span class="play-icon">‚ñ∂</span>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Right: info -->
      <div class="info-col" aria-labelledby="product-title">
        <h1 id="product-title">{{ product.name }}</h1>

        <div class="product-meta">{{ product.description }}</div>

        <div class="price">
          {% if product.price_per_100g %}
            {{ product.price_per_100g }} –≥—Ä–Ω / 100–≥
          {% else %}
            –¶—ñ–Ω–∞ —É—Ç–æ—á–Ω—é—î—Ç—å—Å—è
          {% endif %}
        </div>

        <div class="controls-row">
          <div style="display:flex;align-items:center;gap:8px">
            <button id="qty-decr" class="btn btn-outline" type="button" aria-label="decrease">‚àí</button>
            <input id="qty" class="qty-input" type="number" value="1" min="1" step="1" aria-label="quantity" />
            <button id="qty-incr" class="btn btn-outline" type="button" aria-label="increase">+</button>
          </div>

          <div style="display:flex;gap:10px;align-items:center">
            {% if user.is_authenticated %}
              <button id="addToCart" class="btn-add" data-product-id="{{ product.id }}"
                {% if not product.in_stock %}disabled title="–¢–æ–≤–∞—Ä —Ç–∏–º—á–∞—Å–æ–≤–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π"{% endif %}>
                {% if product.in_stock %}–î–æ –∫–æ—à–∏–∫–∞{% else %}–ù–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ{% endif %}
              </button>
            {% else %}
              <a href="{% url 'login' %}?next={{ request.path }}" class="btn-add">–£–≤—ñ–π—Ç–∏, —â–æ–± –∫—É–ø–∏—Ç–∏</a>
            {% endif %}

            <button id="favBtn" class="btn-fav {% if is_favorited %}favorited{% endif %}" data-product-id="{{ product.id }}" title="–î–æ–¥–∞—Ç–∏ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ" aria-pressed="{% if is_favorited %}true{% else %}false{% endif %}">
              <span id="favIcon">{% if is_favorited %}‚ù§Ô∏è{% else %}ü§ç{% endif %}</span>
            </button>
          </div>
        </div>

        <!-- Stock status + staff toggle -->
        <div style="display:flex;align-items:center;gap:12px;margin-top:12px;">
          {% if product.in_stock %}
            <span id="stockBadge" class="stock-badge stock-yes">–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</span>
          {% else %}
            <span id="stockBadge" class="stock-badge stock-no">–ù–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</span>
          {% endif %}

          {% if user.is_staff %}
            <button id="toggleStockBtn" data-product-id="{{ product.id }}" class="toggle-stock-btn">
              {% if product.in_stock %}–ü–æ—Å—Ç–∞–≤–∏—Ç–∏ —è–∫ ¬´–Ω–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ¬ª{% else %}–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –≤ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å{% endif %}
            </button>
          {% endif %}
        </div>

        <div id="product-msg" aria-live="polite"></div>

        <hr style="border-color: rgba(255,255,255,0.04)">

        <h4 style="color:var(--white)">–û–ø–∏—Å</h4>
        <p style="color:var(--muted)">{{ product.description }}</p>

        <!-- Reviews -->
        <section id="reviews" style="margin-top:28px;">
          <h3 style="color:var(--white)">–í—ñ–¥–≥—É–∫–∏{% if average_rating %} ‚Äî —Å–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–π—Ç–∏–Ω–≥: {{ average_rating }}{% endif %}</h3>

          {% if user.is_authenticated %}
            <form id="reviewForm" method="post" style="margin-top:12px;" onsubmit="return false;">
              {% csrf_token %}
              <label style="color:var(--muted)">–†–µ–π—Ç–∏–Ω–≥:
                <select name="rating" id="reviewRating">
                  <option value="5">5</option>
                  <option value="4">4</option>
                  <option value="3">3</option>
                  <option value="2">2</option>
                  <option value="1">1</option>
                </select>
              </label>
              <div style="margin-top:8px;">
                <textarea name="comment" id="reviewComment" rows="3" style="width:100%;background:rgba(255,255,255,0.03);color:var(--white);border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:6px;" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å —Å–≤—ñ–π –≤—ñ–¥–≥—É–∫ (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)"></textarea>
              </div>
              <div style="margin-top:8px;">
                <button id="submitReviewBtn" class="btn-action" type="button">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—ñ–¥–≥—É–∫</button>
              </div>
              <div id="reviewMsg" style="margin-top:8px;color:var(--muted)"></div>
            </form>
          {% else %}
            <p style="color:var(--muted)">–©–æ–± –∑–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫, –±—É–¥—å-–ª–∞—Å–∫–∞ <a href="{% url 'login' %}?next={{ request.path }}">—É–≤—ñ–π–¥—ñ—Ç—å</a>.</p>
          {% endif %}

          <div id="reviewsList" style="margin-top:18px;">
            {% if reviews %}
              {% for r in reviews %}
                <div class="review-card" role="article" aria-label="–í—ñ–¥–≥—É–∫ –≤—ñ–¥ {{ r.user.username }}">
                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div style="font-weight:800;color:var(--white)">{{ r.user.username }}</div>
                    <div style="color:var(--muted)">{{ r.created_at|date:"SHORT_DATETIME_FORMAT" }}</div>
                  </div>
                  <div style="margin-top:6px;color:var(--muted)">–†–µ–π—Ç–∏–Ω–≥: {{ r.rating }} / 5</div>
                  {% if r.comment %}
                    <div style="margin-top:8px;color:var(--muted)">{{ r.comment }}</div>
                  {% endif %}
                </div>
              {% endfor %}
            {% else %}
              <p style="color:var(--muted)">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –≤—ñ–¥–≥—É–∫—ñ–≤ ‚Äî –±—É–¥—å—Ç–µ –ø–µ—Ä—à–∏–º.</p>
            {% endif %}
          </div>
        </section>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Scoped selectors
  const mediaContainer = document.getElementById('mediaContainer');
  const thumbs = document.getElementById('thumbs');
  const qtyInput = document.getElementById('qty');
  const qtyIncr = document.getElementById('qty-incr');
  const qtyDecr = document.getElementById('qty-decr');
  const addBtn = document.getElementById('addToCart');
  const favBtn = document.getElementById('favBtn');
  const favIcon = document.getElementById('favIcon');
  const submitBtn = document.getElementById('submitReviewBtn');
  const reviewMsgEl = document.getElementById('reviewMsg');
  const toggleBtn = document.getElementById('toggleStockBtn');
  const stockBadge = document.getElementById('stockBadge');

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i=0;i<cookies.length;i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length+1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length+1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // Quantity handlers
  if (qtyIncr && qtyDecr && qtyInput) {
    qtyIncr.addEventListener('click', () => qtyInput.value = Math.max(1, parseInt(qtyInput.value||1) + 1));
    qtyDecr.addEventListener('click', () => qtyInput.value = Math.max(1, parseInt(qtyInput.value||1) - 1));
  }

  // Gallery logic (one handler)
  if (mediaContainer && thumbs) {
    function extractYouTubeId(url) {
      if (!url) return null;
      const patterns = [
        /(?:v=)([0-9A-Za-z_-]{11})/,
        /(?:embed\/)([0-9A-Za-z_-]{11})/,
        /(?:youtu\.be\/)([0-9A-Za-z_-]{11})/,
        /(?:shorts\/)([0-9A-Za-z_-]{11})/
      ];
      for (const re of patterns) {
        const m = url.match(re);
        if (m && m[1]) return m[1];
      }
      const any = url.match(/([0-9A-Za-z_-]{11})/);
      return any ? any[1] : null;
    }

    function showImage(url) {
      mediaContainer.innerHTML = '';
      const img = document.createElement('img');
      img.className = 'product-img';
      img.src = url;
      img.alt = '{{ product.name|escapejs }}';
      img.onerror = function(){ this.onerror=null; this.src = '{% static "images/png/placeholder.png" %}'; };
      mediaContainer.appendChild(img);
    }

    function showYouTube(url) {
      const vid = extractYouTubeId(url);
      if (!vid) { window.open(url, '_blank'); return; }
      mediaContainer.innerHTML = '';
      const iframe = document.createElement('iframe');
      iframe.className = 'product-iframe';
      iframe.src = 'https://www.youtube.com/embed/' + vid + '?rel=0&modestbranding=1';
      iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
      iframe.allowFullscreen = true;
      iframe.frameBorder = 0;
      mediaContainer.appendChild(iframe);
    }

    // mark first thumbnail active
    const list = thumbs.querySelectorAll('.thumb');
    if (list.length) list[0].classList.add('active');

    thumbs.querySelectorAll('.thumb').forEach(t => {
      t.addEventListener('click', function () {
        const type = this.dataset.type || 'image';
        if (type === 'image') {
          const url = this.dataset.imgUrl;
          if (url) showImage(url);
        } else if (type === 'video') {
          const vurl = this.dataset.videoUrl || this.getAttribute('data-video-url') || '';
          if (vurl) showYouTube(vurl);
        }
        thumbs.querySelectorAll('.thumb').forEach(x => x.classList.remove('active'));
        this.classList.add('active');
      });
    });
  }

  // Add to cart (AJAX)
  if (addBtn) {
    addBtn.addEventListener('click', async function(){
      const pid = this.dataset.productId;
      const qty = Math.max(1, parseInt(qtyInput.value || 1));
      const data = new FormData();
      data.append('product_id', pid);
      data.append('quantity', qty);
      data.append('name', '{{ product.name|escapejs }}');
      data.append('price', '{{ product.price_per_100g|default:"0" }}');
      data.append('currency', 'UAH');
      const currentImg = mediaContainer && mediaContainer.querySelector('img') ? mediaContainer.querySelector('img').src : '{% static "images/png/placeholder.png" %}';
      data.append('image', currentImg);

      this.disabled = true;
      const origText = this.textContent;
      this.textContent = '–î–æ–¥–∞—é...';
      try {
        const res = await fetch("{% url 'add_to_cart' %}", {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken},
          body: data,
          credentials: 'same-origin'
        });
        const json = await res.json().catch(()=>({ok:false, error:'Invalid response'}));
        if (!res.ok) {
          if (json && json.login_url) {
            window.location.href = json.login_url + '&next=' + encodeURIComponent(window.location.pathname);
            return;
          }
          document.getElementById('product-msg').textContent = json.error || '–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è';
        } else {
          if (json.ok) {
            document.getElementById('product-msg').textContent = '–î–æ–¥–∞–Ω–æ –≤ –∫–æ—à–∏–∫';
            document.querySelectorAll('#cart-count').forEach(el => el.textContent = json.cart_count);
          } else {
            document.getElementById('product-msg').textContent = json.error || '–ü–æ–º–∏–ª–∫–∞';
          }
        }
      } catch (err) {
        console.error(err);
        document.getElementById('product-msg').textContent = '–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ';
      } finally {
        this.disabled = false;
        this.textContent = origText;
      }
    });
  }

  // Favorite toggle
  if (favBtn) {
    favBtn.addEventListener('click', async function(){
      const pid = this.dataset.productId;
      const was = this.classList.contains('favorited');
      try {
        const res = await fetch("{% url 'toggle_favorite' %}", {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken},
          body: new URLSearchParams({product_id: pid}),
          credentials: 'same-origin'
        });
        const json = await res.json();
        if (!res.ok && json && json.login_url) {
          window.location.href = json.login_url + '&next=' + encodeURIComponent(window.location.pathname);
          return;
        }
        if (json.ok) {
          if (json.favorited) { favBtn.classList.add('favorited'); favIcon.textContent = '‚ù§Ô∏è'; }
          else { favBtn.classList.remove('favorited'); favIcon.textContent = 'ü§ç'; }
        } else {
          alert(json.error || '–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–∞–Ω–æ–≥–æ');
        }
      } catch (err) {
        console.error(err);
        alert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ');
      }
    });
  }

  // Submit review
  if (submitBtn) {
    submitBtn.addEventListener('click', async function(){
      const ratingEl = document.getElementById('reviewRating');
      const commentEl = document.getElementById('reviewComment');
      const rating = ratingEl ? ratingEl.value : '5';
      const comment = commentEl ? commentEl.value : '';
      submitBtn.disabled = true;
      submitBtn.textContent = '–ù–∞–¥—Å–∏–ª–∞—é...';
      reviewMsgEl.textContent = '';
      try {
        const url = "{% url 'submit_review' product.id %}";
        const res = await fetch(url, {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded'},
          body: new URLSearchParams({rating: rating, comment: comment}),
          credentials: 'same-origin'
        });
        const json = await res.json();
        if (!res.ok) {
          if (json && json.login_url) { window.location.href = json.login_url + '&next=' + encodeURIComponent(window.location.pathname); return; }
          reviewMsgEl.style.color = '#ff8a8a';
          reviewMsgEl.textContent = json.error || ('–ü–æ–º–∏–ª–∫–∞: ' + res.status);
        } else {
          reviewMsgEl.style.color = 'lightgreen';
          reviewMsgEl.textContent = json.message || '–î—è–∫—É—î–º–æ –∑–∞ –≤—ñ–¥–≥—É–∫.';
          setTimeout(()=> location.reload(), 800);
        }
      } catch (err) {
        console.error(err);
        reviewMsgEl.style.color = '#ff8080';
        reviewMsgEl.textContent = '–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ –∞–±–æ —Å–µ—Ä–≤–µ—Ä–∞ ‚Äî —Å–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.';
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—ñ–¥–≥—É–∫';
      }
    });
  }

  // Toggle availability (staff)
  if (toggleBtn) {
    toggleBtn.addEventListener('click', async function(){
      if (!confirm('–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –∑–º—ñ–Ω—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ —Ç–æ–≤–∞—Ä—É?')) return;
      const pid = this.dataset.productId;
      const base = "{% url 'toggle_availability' 0 %}";
      const url = base.replace('/0/', '/' + pid + '/');
      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest'},
          credentials: 'same-origin'
        });
        if (!res.ok) throw new Error('network');
        const js = await res.json();
        if (js.ok) {
          if (js.in_stock) {
            stockBadge.textContent = '–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ';
            stockBadge.classList.remove('stock-no'); stockBadge.classList.add('stock-yes');
            toggleBtn.textContent = '–ü–æ—Å—Ç–∞–≤–∏—Ç–∏ —è–∫ ¬´–Ω–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ¬ª';
          } else {
            stockBadge.textContent = '–ù–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ';
            stockBadge.classList.remove('stock-yes'); stockBadge.classList.add('stock-no');
            toggleBtn.textContent = '–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –≤ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å';
          }
        } else {
          alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å');
        }
      } catch (e) {
        console.error(e);
        alert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ –∞–±–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É.');
      }
    });
  }

});
</script>
{% endblock %}